<!doctype html>
<html lang="zh-CN" class="scroll-smooth">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gal Library Pro Â· èµ„æºåˆ†äº«</title>
  <meta name="description" content="Galgame èµ„æºåˆ†äº«ä¸è¯„æµ‹åº“ï¼šèšåˆç™¾ç§‘/è¯„æµ‹/å…¬å‘Š/æ”»ç•¥ç­‰èµ„æ–™ï¼›æ”¯æŒåˆ¶ä½œç¤¾å›¾é‰´ã€æ ‡ç­¾/å¹³å°/å¹´ä»½ç­›é€‰ï¼Œç½‘æ ¼/æ—¶é—´çº¿è§†å›¾ï¼Œåå¥½å¯¼å‡º/å¯¼å…¥ã€‚" />
  <meta name="color-scheme" content="light dark" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' };</script>

  <style>
    /* =================== ä¸»é¢˜ä¸æ»šåŠ¨å˜é‡ =================== */
    :root {
      /* æµ…è‰²ä¸»ç³» */
      --ink: #0b1324;
      --ink-2: #1f2a44;
      --brand: #34c6cf;
      /* é’ç»¿ä¸»è‰² */
      --brand-2: #f78cc7;
      /* æŸ”ç²‰å‰¯è‰² */
      --brand-3: #ffa8a8;
      /* æ©™ç²‰ç‚¹ç¼€ */
      --brand-4: #8a7af7;
      /* é›ç´«ç‚¹ç¼€ï¼ˆå·²ç”¨ï¼‰ */
      /* æ–°å¢ä¸¤å±‚ï¼ˆæµ…è‰²æ›´â€œå¥¶â€ï¼‰ */
      --brand-5: #9be7ff;
      /* æ·¡å¤©é’ */
      --brand-6: #ffd6ea;
      /* æ·¡ç²‰é›¾ */

      /* æš—è‰²ä¸»ç³» */
      --d-brand: #7e6af7;
      /* ç´« */
      --d-2: #2e9df5;
      /* è“ */
      --d-3: #19c2b3;
      /* æ·±é’ */
      /* æ–°å¢ä¸¤å±‚ï¼ˆæš—è‰²æ›´â€œæ·±â€ï¼‰ */
      --d-4: #3b82f6;
      /* é›è“ */
      --d-5: #6d28d9;
      /* æ·±ç´« */

      --card: rgba(255, 255, 255, 0.80);
      /* æµ…è‰²æ¨¡å¼ï¼šç™½è‰² 80% ä¸é€æ˜ */
      --card-dark: rgba(15, 23, 42, 0.82);
      /* æš—è‰²æ¨¡å¼ï¼šæ·±è“ 82% ä¸é€æ˜ */


      --p: 0;
      /* æ»šåŠ¨æ¯”ä¾‹ 0~1 ï¼ˆJS æ›´æ–°ï¼‰ */
      --a1: 120deg;
      /* è§’åº¦1ï¼ˆJS æ›´æ–°ï¼‰ */
      --a2: 220deg;
      /* è§’åº¦2ï¼ˆJS æ›´æ–°ï¼‰ */
      --x1: 20%;
      /* å…‰æ–‘1 x */
      --y1: -6%;
      /* å…‰æ–‘1 y */
      --x2: 86%;
      /* å…‰æ–‘2 x */
      --y2: 2%;
      /* å…‰æ–‘2 y */

      --photo-url: url("./cele.jpg");
      /*èƒŒæ™¯å›¾ */
      --photo-alpha: .55;
      /* æµ…è‰²èƒŒæ™¯å›¾é€æ˜åº¦ï¼ˆæ›´ä½ä»¥å‡¸æ˜¾æ¸å˜ï¼‰ */
      --photo-alpha-dark: .45;
      /* æš—è‰²èƒŒæ™¯å›¾é€æ˜åº¦ï¼ˆæ›´ä½ä»¥å‡¸æ˜¾æ¸å˜ï¼‰ */
    }

    html,
    body {
      height: 100%
    }

    body {
      color: var(--ink);
      background: transparent
    }

    /* =================== èƒŒæ™¯å±‚ï¼ˆå›¾ç‰‡ + å¤šå±‚æ»šåŠ¨æ¸å˜ + ç½‘æ ¼çº¹ç†ï¼‰ =================== */
    #bg-stack {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    #bg-stack .bg-photo {
      position: absolute;
      inset: 0;
      background-image: var(--photo-url);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      filter: saturate(1.05) contrast(1.06);
      opacity: var(--photo-alpha);
      transition: opacity .35s ease, filter .35s ease;
    }

    /* æµ…è‰²ï¼šè¦†ç›–æ›´å¹¿ã€é¢œè‰²æ›´â€œå¥¶â€ã€æ»šåŠ¨æ›´æ˜æ˜¾ */
    #bg-stack .bg-grad {
      position: absolute;
      inset: 0;
      background:
        /* äº®é’å…‰æ–‘ï¼ˆéšæ»šåŠ¨å·¦å³/ä¸Šä¸‹ç§»åŠ¨ï¼‰ */
        radial-gradient(900px 460px at var(--x1) var(--y1), color-mix(in hsl, var(--brand) 48%, transparent), transparent 60%),
        /* æŸ”ç²‰å…‰æ–‘ï¼ˆéšæ»šåŠ¨åå‘ç§»åŠ¨ï¼‰ */
        radial-gradient(820px 420px at var(--x2) var(--y2), color-mix(in hsl, var(--brand-2) 42%, transparent), transparent 62%),
        /* æ–°å¢ï¼šå¤©é’å¤§å…‰æ™•ï¼ˆè¦†ç›–æ›´å¹¿ï¼‰ */
        radial-gradient(1100px 520px at 50% 120%, color-mix(in hsl, var(--brand-5) 40%, transparent), transparent 70%),
        /* æ–°å¢ï¼šæ·¡ç²‰é›¾å¸¦ï¼ˆä¸­å±‚è¿‡æ¸¡ï¼‰ */
        conic-gradient(from calc(var(--a1) + 20deg) at 50% 110%, color-mix(in hsl, var(--brand-6) 26%, transparent) 0 24%, transparent 24% 80%, color-mix(in hsl, var(--brand-3) 12%, transparent) 80%),
        /* åŸæ‰‡å½¢ï¼šæ©™ç²‰ + é’ */
        conic-gradient(from var(--a1) at 50% 115%,
          color-mix(in hsl, var(--brand-3) 26%, transparent) 0 18%,
          transparent 18% 52%,
          color-mix(in hsl, var(--brand) 22%, transparent) 52% 78%,
          transparent 78%),
        /* åŸºåº• */
        linear-gradient(180deg, #f4fbff, #fdf6ff 45%, #fff7f6 100%);
      transition: background .1s linear;
      opacity: .80;
    }

    #bg-stack .bg-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(100, 116, 139, .06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(100, 116, 139, .06) 1px, transparent 1px);
      background-size: 26px 26px, 26px 26px;
      mask-image: radial-gradient(980px 560px at 50% 0%, black, transparent 80%);
    }

    /* æš—è‰²ï¼šæ›´æ·±é‚ƒï¼Œæ»šåŠ¨æ—¶è§’åº¦/ä½ç½®/æµ“åº¦å˜åŒ–æ›´æ˜æ˜¾ */
    .dark #bg-stack .bg-photo {
      opacity: var(--photo-alpha-dark);
      filter: saturate(1.07) contrast(1.08) brightness(.9);
    }

    .dark #bg-stack .bg-grad {
      background:
        radial-gradient(980px 500px at var(--x1) var(--y1), color-mix(in hsl, var(--d-brand) 52%, transparent), transparent 60%),
        radial-gradient(860px 460px at var(--x2) var(--y2), color-mix(in hsl, var(--d-2) 44%, transparent), transparent 62%),
        /* æ–°å¢ï¼šæ·±è“å¤–åœˆ */
        radial-gradient(1200px 600px at 50% -10%, color-mix(in hsl, var(--d-4) 22%, transparent), transparent 70%),
        /* æ–°å¢ï¼šæ·±ç´«æ‰‡å½¢ */
        conic-gradient(from calc(var(--a2) - 30deg) at 50% 118%, color-mix(in hsl, var(--d-5) 28%, transparent) 0 30%, transparent 30% 85%, color-mix(in hsl, var(--d-3) 18%, transparent) 85%),
        /* åŸæ‰‡å½¢ï¼šæ·±é’/ç´« */
        conic-gradient(from var(--a2) at 50% 115%,
          color-mix(in hsl, var(--d-3) 34%, transparent) 0 22%,
          transparent 22% 58%,
          color-mix(in hsl, var(--d-brand) 30%, transparent) 58% 82%,
          transparent 82%),
        linear-gradient(180deg, #0a1222, #0e1730 68%, #0a1121 100%);
      opacity: .85;
    }

    .dark #bg-stack .bg-grid {
      background-image:
        linear-gradient(rgba(148, 163, 184, .08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(148, 163, 184, .08) 1px, transparent 1px);
    }

    /* =================== å…¨å±€ç»†èŠ‚ =================== */
    .glass {
      background: rgba(255, 255, 255, .66);
      backdrop-filter: blur(12px);
    }

    .dark .glass {
      background: rgba(13, 18, 34, .55);
    }

    .soft-shadow {
      box-shadow: 0 16px 40px rgba(2, 6, 23, .12);
    }

    .ring-grad {
      border: 1px solid transparent;
      background:
        linear-gradient(var(--card), var(--card)) padding-box,
        linear-gradient(135deg, var(--brand) 10%, var(--brand-2) 50%, var(--brand-3) 90%) border-box;
      border-radius: 18px;
    }

    .card {
      background: rgba(255, 255, 255, 0.35);
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, .08);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(3px);
    }

    .dark .card {
      background: rgba(15, 23, 42, 0.45);
      border-color: rgba(148, 163, 184, .16);
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(3px);
    }

    .btn {
      display: inline-flex;
      /* æ–°å¢ */
      align-items: center;
      /* æ–°å¢ */
      justify-content: center;
      /* æ–°å¢ */
      line-height: 1;
      /* æ–°å¢ï¼šå»æ‰åŸºçº¿å·®å¼‚ */
      border-radius: 12px;
      border: 1px solid rgba(15, 23, 42, .12);
      padding: .55rem .9rem;
      background: rgba(255, 255, 255, .75);
      transition: box-shadow .2s ease, transform .15s ease;
    }



    .btn:hover {
      box-shadow: 0 10px 28px rgba(15, 23, 42, .12);
    }

    .btn:active {
      transform: translateY(1px);
    }

    .dark .btn {
      background: rgba(15, 23, 42, .7);
      border-color: rgba(148, 163, 184, .18);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--brand), var(--brand-2));
      color: #fff;
      border: 0;
    }

    .btn-primary:hover {
      opacity: .96;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: .35rem;
      padding: .25rem .55rem;
      border-radius: 999px;
      font-size: .72rem;
      line-height: 1;
      color: #fff;
    }

    .pill.c1 {
      background: color-mix(in hsl, var(--brand) 75%, #fff);
    }

    .pill.c2 {
      background: color-mix(in hsl, var(--brand-2) 78%, #fff);
    }

    .pill.c3 {
      background: color-mix(in hsl, var(--brand-3) 78%, #fff);
    }

    .pill.c4 {
      background: color-mix(in hsl, var(--brand-4) 75%, #fff);
    }

    .pill.c5 {
      background: color-mix(in hsl, var(--brand-5) 78%, #fff);
    }

    .pill.c6 {
      background: color-mix(in hsl, var(--brand-6) 78%, #fff);
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 2;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      line-clamp: 3;
    }

    .sensitive-blur {
      filter: blur(12px) grayscale(30%);
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, var(--brand), var(--brand-2));
      border-radius: 12px
    }

    #app {
      position: relative;
      z-index: 1;
    }

    /* å³ä¸Šè§’ï¼šä¸»é¢˜ + ç”¨æˆ·ï¼ˆå¹¶æ’å›ºå®šï¼‰ */
    .top-right-stack {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 40;
      display: flex;
      gap: .5rem;
      align-items: center;
      /* æ–°å¢ï¼šè®©å¤´åƒã€æ–‡å­—ã€æŒ‰é’®å‚ç›´å±…ä¸­å¯¹é½ */
    }

    /* å³ä¸Šè§’æŒ‰é’®ç»Ÿä¸€é«˜åº¦ä¸åŸºçº¿ï¼Œå»æ‰ emoji é€ æˆçš„ä¸Šä¸‹ä¸é½ */
    /* å³ä¸Šè§’æŒ‰é’®ï¼šç»Ÿä¸€å­—å·ï¼Œä¸å…è®¸æ¢è¡Œï¼Œä¿æŒå›ºå®šé«˜ */
    .top-right-stack .btn {
      height: 32px;
      padding: 0 .8rem;
      line-height: 1;
      /* é˜²æ­¢ emoji æ‹‰é«˜è¡Œé«˜ */
      font-size: 12px;
      /* ç›´æ¥å®šæ­»å­—å·ï¼Œé¿å… xs/sm å†²çª */
      white-space: nowrap;
      /* é˜²æ­¢â€œå¹´é¾„è®¾ç½®â€ç­‰åœ¨çª„å±æŠ˜è¡Œ */
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }


    /* å³ä¸Šè§’ï¼šç”¨æˆ·å…¥å£å®¹å™¨ ä¹Ÿæ‹‰æˆæ°´å¹³å±…ä¸­ */
    #userEntry {
      display: flex;
      align-items: center;
    }


    /* ç”¨æˆ·å¤´åƒæŒ‰é’® */
    .avatar {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      overflow: hidden;
      display: grid;
      place-items: center;
      background: #e2e8f0;
      color: #334155;
      font-weight: 700;
    }

    .dark .avatar {
      background: #1f2937;
      color: #cbd5e1;
    }

    /* å­é¡µé¢å›é€€æŒ‰é’® */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
    }
  </style>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
    // ç»Ÿä¸€æˆ hash è·¯ç”±ï¼Œé¿å… file:// ä¸‹çš„ /game/xx è§£æè¾¹ç¼˜æƒ…å†µ
    (function normalizeRouteToHash() {
      try {
        const m = location.pathname.match(/\/game\/([^/?#]+)$/);
        if (m && !location.hash) {
          const qs = location.search || "";
          location.replace(`#/game/${m[1]}${qs}`);
        }
      } catch (e) { }
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>


  <style>
    /* ===== èƒŒæ™¯å±‚ï¼šä¸¤ä¸ª iframe å…¬ç”¨çš„åº•å±‚æ ·å¼ ===== */
    #sakura-frame,
    #startrail-frame {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      border: 0;
      z-index: 0;
      /* ä¸ç”¨ -1ï¼Œé¿å…è¢«å…¶å®ƒ fixed å±‚æŒ¡ä½äº‹ä»¶æµï¼›åæ­£å·²ç¦ç”¨æŒ‡é’ˆ */
      pointer-events: none;
      /* ä¸æ‹¦æˆªç‚¹å‡»/æ»šåŠ¨ */
      opacity: 0;
      /* é»˜è®¤éšè—ï¼Œäº¤ç»™ä¸»é¢˜è§„åˆ™æ§åˆ¶ */
      transition: opacity .25s ease;
    }

    /* ===== ä½ çš„åŸæ¸å˜èƒŒæ™¯ï¼šåœ¨ iframe ä¹‹ä¸Š ===== */
    #bg-stack {
      position: fixed;
      inset: 0;
      z-index: 1;
      /* æ¯” iframe é«˜ä¸€å±‚ */
      pointer-events: none;
      opacity: 1;
      /* é»˜è®¤å¯è§ï¼ˆæµ…è‰²ï¼‰ */
      transition: opacity .25s ease;
    }

    /* ===== é¡µé¢å†…å®¹ï¼šæœ€ä¸Šå±‚ ===== */
    #app {
      position: relative;
      z-index: 2;
    }

    /* ===== ä¸»é¢˜åˆ‡æ¢æ˜¾éšè§„åˆ™ ===== */
    /* æµ…è‰²ï¼šæ˜¾ç¤º sakura + æ¸å˜ï¼›éšè—æ˜Ÿè½¨ */
    html:not(.dark) #sakura-frame {
      opacity: 1;
    }

    html:not(.dark) #bg-stack {
      opacity: 1;
    }

    html:not(.dark) #startrail-frame {
      opacity: 0;
    }

    /* æš—è‰²ï¼šæ˜¾ç¤ºæ˜Ÿè½¨ï¼›éšè— sakura ä¸æ¸å˜ */
    .dark #startrail-frame {
      opacity: 1;
    }

    .dark #sakura-frame {
      opacity: 0;
    }

    .dark #bg-stack {
      opacity: 0;
    }
  </style>

  <style>
    /* é¦–å¸§ï¼šè·Ÿéšç³»ç»Ÿï¼›ç­‰ JS æ¥ç®¡åå†ç²¾ç»†æ§åˆ¶ */
    @media (prefers-color-scheme: dark) {
      #sakura-frame {
        opacity: 0
      }

      #startrail-frame {
        opacity: 1
      }

      #bg-stack {
        opacity: 0
      }
    }

    @media (prefers-color-scheme: light) {
      #sakura-frame {
        opacity: 1
      }

      #startrail-frame {
        opacity: 0
      }

      #bg-stack {
        opacity: 1
      }
    }
  </style>
  <script>
    (function () {
      var KEY = 'theme';
      var pref = localStorage.getItem(KEY) || 'system';
      var isSysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      var useDark = (pref === 'dark') || (pref === 'system' && isSysDark);
      document.documentElement.classList.toggle('dark', useDark);
    })();
  </script>

</head>

<body class="text-slate-800 dark:text-slate-200">

  <iframe id="sakura-frame" src="./sakura.html" aria-hidden="true"></iframe>


  <iframe id="startrail-frame" src="./room_startrail.html" aria-hidden="true"></iframe>

  <!-- èƒŒæ™¯æ ˆ -->
  <div id="bg-stack" aria-hidden="true">
    <div class="bg-photo"></div>
    <div class="bg-grad"></div>
    <div class="bg-grid"></div>
  </div>

  <div id="app" class="min-h-screen flex flex-col">

    <!-- é¡¶æ ï¼ˆä¿æŒä¸åŠ¨ï¼‰ -->
    <header class="sticky top-0 z-30 glass soft-shadow border-b border-white/50 dark:border-slate-700/50">
      <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
        <button @click="showNav=!showNav" class="sm:hidden btn" aria-label="èœå•">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
            <path d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
        <div class="flex items-center gap-2 font-semibold text-slate-900 dark:text-white">
          <div class="w-7 h-7 rounded-xl ring-grad grid place-items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 3l8 4.5v9L12 21 4 16.5v-9L12 3z" />
            </svg>
          </div>
          <span class="tracking-tight">Gal Library Pro</span>
        </div>
        <nav :class="['ml-auto sm:flex items-center gap-5 text-sm', showNav?'flex':'hidden']">
          <a href="#/home" class="hover:text-[var(--brand)]" @click.prevent="nav('#/home')">èµ„æº</a>
          <a href="#" class="hover:text-[var(--brand)]" @click.prevent="viewMode='timeline'">æ—¶é—´çº¿</a>
          <a href="#/home" class="hover:text-[var(--brand)]" @click.prevent="viewMode='studios'; nav('#/home')">
            åˆ¶ä½œç¤¾å›¾é‰´
          </a>
          <a href="#about" class="hover:text-[var(--brand)]">å…³äº</a>
        </nav>
        <div class="ml-2 flex items-center gap-2">
          <button class="btn text-xs sm:text-sm" @click="toggleDark">
            {{ pref==='system' ? (isDark ? 'ğŸŒ“ ç³»ç»ŸÂ·æš—' : 'ğŸŒ“ ç³»ç»ŸÂ·æµ…') : (pref==='dark' ? 'ğŸŒ™ æš—è‰²' : 'â˜€ï¸ æµ…è‰²') }}
          </button>


          <template v-if="auth.loggedIn">
            <div class="relative" @click.stop>
              <button class="avatar border border-white/60 dark:border-slate-700 overflow-hidden"
                @click="avatarOpen=!avatarOpen">
                <img v-if="auth.user?.avatarUrl" :src="auth.user.avatarUrl" class="w-full h-full object-cover">
                <span v-else>{{ (auth.user?.displayName||'U').slice(0,1).toUpperCase() }}</span>
              </button>
              <div v-show="avatarOpen"
                class="absolute right-0 mt-2 w-44 glass border border-slate-200 dark:border-slate-700 rounded-xl p-2 soft-shadow">
                <a href="#/profile" class="block px-3 py-2 rounded-lg hover:bg-white/60 dark:hover:bg-white/10">æˆ‘çš„èµ„æ–™</a>
                <a href="#/favorites"
                  class="block px-3 py-2 rounded-lg hover:bg-white/60 dark:hover:bg-white/10">æˆ‘çš„æ”¶è—</a>
                <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-white/60 dark:hover:bg-white/10"
                  @click="doLogout">é€€å‡ºç™»å½•</button>
              </div>
            </div>
          </template>

          <template v-else>
            <a href="#/register" class="btn">æ³¨å†Œ</a>
            <a href="#/login" class="btn">ç™»å½•</a>
          </template>

          <button @click="openAgeGate=true" class="btn text-xs sm:text-sm">å¹´é¾„è®¾ç½®</button>
        </div>

      </div>
    </header>

    <!-- è·¯ç”±è§†å›¾ï¼šä¸»é¡µ/èµ„æ–™/æ”¶è—/ç™»å½•/æ³¨å†Œ -->
    <section v-if="route==='/home'" class="relative">
      <!-- è‹±é›„åŒºï¼ˆä¸å˜ï¼‰ -->
      <div class="max-w-7xl mx-auto px-4 pt-10 pb-8 sm:pt-14">
        <div class="grid lg:grid-cols-2 gap-8 items-end">
          <div>
            <h1 class="text-3xl sm:text-4xl font-black leading-tight tracking-tight">Gal Â· èµ„æºåˆ†äº«ä¸è¯„æµ‹åº“</h1>
            <p class="mt-3 text-slate-700/90 dark:text-slate-300">ä¸‹è½½èµ„æº / èšåˆç™¾ç§‘ / è¯„æµ‹ / å…¬å‘Š / æ”»ç•¥ç­‰èµ„æ–™ã€‚æœªæˆå¹´äººè¯·å‹¿æµè§ˆ R-18 å†…å®¹ã€‚</p>
            <div class="mt-4 flex flex-wrap gap-2 text-xs">
              <span class="pill c1"># ç™¾ç§‘</span>
              <span class="pill c2"># è¯„æµ‹</span>
              <span class="pill c3"># æ”»ç•¥</span>
              <span class="pill c4"># è®¾å®šé›†</span>
              <span class="pill c5"># OST</span>
              <span class="pill c6"># å‘¨è¾¹</span>
            </div>
          </div>

          <!-- æœç´¢/ç­›é€‰ä¸»å¡ -->
          <div class="glass soft-shadow ring-grad p-3">
            <div class="flex items-stretch gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 my-auto text-slate-400" viewBox="0 0 24 24"
                fill="currentColor">
                <path fill-rule="evenodd"
                  d="M10.5 3a7.5 7.5 0 105.26 12.78l3.73 3.73a.75.75 0 101.06-1.06l-3.73-3.73A7.5 7.5 0 0010.5 3zm0 1.5a6 6 0 100 12 6 6 0 000-12z"
                  clip-rule="evenodd" />
              </svg>
              <input v-model="q" @input="debouncedApply(160)" @keydown.enter.prevent="applyFilters()" type="text"
                placeholder="æœç´¢ æ ‡é¢˜/åˆ«å/æ ‡ç­¾ï¼ˆæŒ‰ / èšç„¦ï¼‰" class="flex-1 bg-transparent outline-none text-sm" />

              <select v-model="filters.platform" @change="applyFilters"
                class="text-sm px-2 py-1.5 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent">
                <option value="">å…¨éƒ¨å¹³å°</option>
                <option v-for="p in platforms" :key="p" :value="p">{{ p }}</option>
              </select>
              <button @click="viewMode='grid'"
                :class="['btn px-3 text-xs', viewMode==='grid'?'btn-primary':'']">ç½‘æ ¼</button>
              <button @click="viewMode='timeline'"
                :class="['btn px-3 text-xs', viewMode==='timeline'?'btn-primary':'']">æ—¶é—´çº¿</button>
              <button @click="viewMode='studios'"
                :class="['btn px-3 text-xs', viewMode==='studios'?'btn-primary':'']">å›¾é‰´</button>
              <button @click="resetFilters" class="btn text-xs">é‡ç½®</button>
            </div>

            <div class="mt-3 grid grid-cols-1 lg:grid-cols-5 gap-3">
              <select v-model="filters.sort" @change="applyFilters"
                class="lg:col-span-1 text-sm px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent">
                <option value="-hot">æ’åºï¼šçƒ­åº¦â†“</option>
                <option value="-rating">æ’åºï¼šè¯„åˆ†â†“</option>
                <option value="-date">æ’åºï¼šå‘å”®æ—¶é—´â†“</option>
                <option value="title">æ’åºï¼šæ ‡é¢˜Aâ†’Z</option>
              </select>
              <div class="lg:col-span-4 flex items-center flex-wrap gap-2">
                <button v-for="t in tagPool" :key="t" @click="toggleTag(t)" :class="['px-3 py-1.5 rounded-full border text-sm transition',
                    filters.tags.includes(t)
                      ? 'border-transparent text-white bg-gradient-to-r from-[var(--brand)] via-[var(--brand-2)] to-[var(--brand-3)]'
                      : 'border-slate-300/60 dark:border-slate-700 hover:bg-white/50 dark:hover:bg-white/5']">#{{ t
                  }}</button>
              </div>
            </div>

            <div
              class="mt-3 rounded-xl p-3 border border-slate-300/60 dark:border-slate-700 bg-white/50 dark:bg-white/0">
              <div class="flex items-center justify-between text-sm">
                <div>å¹´ä»½èŒƒå›´ï¼š<span class="font-medium">{{ yearRange[0] }}</span> - <span class="font-medium">{{
                    yearRange[1] }}</span></div>
                <button class="btn text-xs px-2 py-1" @click="resetYears">é‡ç½®å¹´ä»½</button>
              </div>
              <div class="mt-2">
                <div
                  class="h-1.5 rounded-full bg-gradient-to-r from-[var(--brand)] via-[var(--brand-2)] to-[var(--brand-3)] relative">
                  <input type="range" :min="minYear" :max="maxYear" v-model.number="yearRange[0]"
                    @input="fixYearOrder('min')" class="w-full absolute -top-2 opacity-70" />
                  <input type="range" :min="minYear" :max="maxYear" v-model.number="yearRange[1]"
                    @input="fixYearOrder('max')" class="w-full relative opacity-70" />
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- é¡¶éƒ¨çŠ¶æ€ -->
        <div class="mt-4 flex items-center justify-between">
          <p class="text-sm text-slate-700/80 dark:text-slate-400" v-if="!ageVerified">
            å¯èƒ½ R-18 å°é¢å·²æ¨¡ç³Šã€‚<button class="ml-1 underline decoration-dotted hover:text-[var(--brand)]"
              @click="openAgeGate=true">æˆ‘å·²å¹´æ»¡ 18 å²</button>
          </p>
          <div class="ml-auto text-xs text-slate-600 dark:text-slate-400" v-if="viewMode!=='studios'">å…± {{ total }} é¡¹ï¼Œé¡µ
            {{ page }} / {{ pages }}</div>
        </div>
      </div>

      <!-- ä¸»ä½“ï¼ˆèµ„æº/æ—¶é—´çº¿/å›¾é‰´ï¼‰ -->
      <main class="flex-1">
        <div class="max-w-7xl mx-auto px-4 pb-16">
          <!-- éª¨æ¶ -->
          <div v-if="loading" class="grid grid-cols-2 sm:grid-cols-3 gap-5">
            <div v-for="n in 9" :key="n" class="card overflow-hidden">
              <div class="aspect-[4/5] bg-slate-200/60 dark:bg-slate-800 animate-pulse"></div>
              <div class="p-3 space-y-2">
                <div class="h-4 bg-slate-200/70 dark:bg-slate-700 rounded"></div>
                <div class="h-3 bg-slate-200/70 dark:bg-slate-700 rounded w-1/2"></div>
              </div>
            </div>
          </div>
          <template v-else-if="viewMode==='grid'">
            <!-- ç½‘æ ¼ -->
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-5">
              <article v-for="g in pageView" :key="g.id"
                class="card overflow-hidden soft-shadow transition-transform duration-300 hover:-translate-y-0.5">
                <div class="relative aspect-[4/5] bg-slate-100 dark:bg-slate-800">
                  <img :src="coverAnime(g)" alt
                    class="w-full h-full object-cover transition-transform duration-300 hover:scale-[1.02]"
                    :class="g.isAdult && !ageVerified ? 'sensitive-blur' : ''" loading="lazy" />
                  <div class="absolute inset-x-3 top-3 flex gap-2">
                    <span v-if="g.isAdult" class="pill c3 uppercase">R-18</span>
                    <span class="pill c2 text-[10px]">{{ g.platforms.join('/') }}</span>
                    <span class="pill c1 text-[10px]">{{ g.maker }}</span>
                    <!-- æ”¶è—å¾½æ ‡å³æ—¶å±•ç¤º -->
                    <span v-if="isFav(g.id)" class="pill c4">â˜… å·²æ”¶è—</span>
                  </div>
                  <div class="absolute inset-x-3 bottom-3 flex items-center justify-between text-xs">
                    <span class="pill c4">è¯„åˆ† {{ g.rating.toFixed(1) }}</span>
                    <span class="pill c1">çƒ­åº¦ {{ g.hot }}</span>
                  </div>
                </div>
                <div class="p-3">
                  <h3 class="font-semibold line-clamp-2 hover:underline cursor-pointer" @click="goGame(g)"
                    @mouseenter="scheduleQuickView(g)" @mouseleave="cancelQuickView" @focus="scheduleQuickView(g)"
                    @blur="cancelQuickView" tabindex="0">{{ g.title }}</h3>

                  <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">å‘å”®ï¼š{{ fmtDate(g.releaseDate) }}</p>
                  <p class="text-sm text-slate-700 dark:text-slate-300 mt-2 line-clamp-3">{{ g.desc }}</p>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <span v-for="t in g.tags" :key="t"
                      class="text-[11px] px-2 py-0.5 rounded-full border border-slate-300/60 dark:border-slate-700">#{{
                      t }}</span>
                  </div>
                  <div class="mt-4 grid grid-cols-3 gap-2">
                    <button class="btn text-sm" @click="goGame(g,'resources')">èµ„æº</button>
                    <button class="btn text-sm" @click="goGame(g)">è¯¦æƒ…</button>
                    <button class="btn text-sm" :class="isFav(g.id)?'btn-primary':''" @click="toggleFav(g)">{{
                      isFav(g.id)?'â˜… å·²æ”¶è—':'â˜† æ”¶è—' }}</button>

                  </div>
                </div>
              </article>
            </div>

            <!-- æ•°å­—åˆ†é¡µ -->
            <div v-if="pages>1" class="mt-8 flex items-center justify-center gap-2 flex-wrap">
              <button class="btn" :disabled="page<=1" @click="toPage(page-1)">ä¸Šä¸€é¡µ</button>
              <button v-for="n in pageNumbers" :key="n.key" class="btn" :class="n.num===page ? 'btn-primary' : ''"
                :disabled="n.num==='â€¦'" @click="typeof n.num==='number' && toPage(n.num)">{{ n.num }}</button>
              <button class="btn" :disabled="page>=pages" @click="toPage(page+1)">ä¸‹ä¸€é¡µ</button>
            </div>
          </template>
          <!-- æ—¶é—´çº¿ -->
          <div v-else-if="viewMode==='timeline'">
            <div v-for="year in timelineYears" :key="year" class="mb-6">
              <div v-for="g in timelineMap[year]" :key="g.id" class="card soft-shadow p-3 flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-[var(--brand)] shadow-[0_0_0_4px_rgba(52,198,207,.2)]"></div>
                <img :src="coverAnime(g)" alt
                  class="w-16 h-20 object-cover rounded-md border border-slate-300/60 dark:border-slate-700"
                  :class="g.isAdult && !ageVerified ? 'sensitive-blur':''" loading="lazy">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <p class="font-semibold line-clamp-1 hover:underline cursor-pointer" @click="goGame(g)"
                      @mouseenter="scheduleQuickView(g)" @mouseleave="cancelQuickView" @focus="scheduleQuickView(g)"
                      @blur="cancelQuickView" tabindex="0">{{ g.title }}</p>
                    <span v-if="g.isAdult" class="pill c3 uppercase">R-18</span>
                    <span class="pill c2 text-[10px]">{{ g.platforms.join('/') }}</span>
                    <span class="pill c1 text-[10px]">{{ g.maker }}</span>
                    <span v-if="isFav(g.id)" class="pill c4">â˜… å·²æ”¶è—</span>
                  </div>
                  <p class="text-xs text-slate-500 mt-0.5">å‘å”®ï¼š{{ fmtDate(g.releaseDate) }} Â· è¯„åˆ† {{ g.rating.toFixed(1)
                    }} Â· çƒ­åº¦ {{ g.hot }}</p>
                  <p class="text-sm text-slate-700 dark:text-slate-300 mt-1 line-clamp-2">{{ g.desc }}</p>
                </div>
                <div class="flex items-center gap-2">
                  <button class="btn text-xs" @click="goGame(g,'resources')">èµ„æº</button>
                  <button class="btn text-xs" @click="goGame(g)">è¯¦æƒ…</button>
                  <button class="btn text-xs" :class="isFav(g.id)?'btn-primary':''" @click="toggleFav(g)">{{
                    isFav(g.id)?'â˜… å·²æ”¶è—':'â˜† æ”¶è—' }}</button>
                </div>
              </div>
            </div>
            <div class="mt-6 text-center">
              <a href="#/home" class="btn btn-primary">å›åˆ°é¡¶éƒ¨</a>
            </div>
          </div>


          <!-- åˆ¶ä½œç¤¾å›¾é‰´ -->
          <div v-else-if="viewMode==='studios'" class="space-y-6">
            <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
              <div class="flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
                <h3 class="font-bold text-lg">åˆ¶ä½œç¤¾å›¾é‰´</h3>
                <div class="flex items-center gap-2">
                  <input v-model.trim="studioQ" placeholder="æœç´¢åˆ¶ä½œç¤¾ / äººç‰© / ä½œå“"
                    class="px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
                  <select v-model="studioSort"
                    class="px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm">
                    <option value="name">æŒ‰åç§°</option>
                    <option value="founded">æŒ‰æˆç«‹æ—¶é—´</option>
                    <option value="works">æŒ‰ä»£è¡¨ä½œæ•°é‡</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5">
              <article v-for="(m, name) in studioView" :key="name" class="card soft-shadow overflow-hidden">
                <div class="relative aspect-[5/2] bg-slate-100 dark:bg-slate-800">
                  <img :src="bannerCandidates(name, m)[0]" :data-idx="0" class="w-full h-full object-cover"
                    alt="studio-banner" @error="(e)=>{
    const c = bannerCandidates(name, m);
    let i = Number(e.target.dataset.idx || 0) + 1;
    if (i < c.length){ e.target.dataset.idx = i; e.target.src = c[i]; }
  }" />

                  <div class="absolute bottom-2 left-2 right-2 flex items-center justify-between">
                    <span class="pill c4">æˆç«‹ {{ m.founded || 'â€”' }}</span>
                    <span class="pill c1">{{ m.works?.length || 0 }} éƒ¨ä»£è¡¨ä½œ</span>
                  </div>
                  <!-- æ”¶è—å¾½æ ‡ -->
                  <div class="absolute top-2 left-2">
                    <span v-if="isFavStudio(name)" class="pill c5">â˜… å·²æ”¶è—</span>
                  </div>
                </div>
                <div class="p-3">
                  <h4 class="font-semibold">{{ name }}</h4>
                  <p class="text-sm text-slate-700 dark:text-slate-300 mt-1 line-clamp-3">{{ m.intro || 'æš‚æ— ç®€ä»‹' }}</p>

                  <div class="mt-3">
                    <div class="flex gap-2 text-xs">
                      <button @click="m._tab='intro'; $forceUpdate()"
                        :class="['btn px-2 py-1', (m._tab||'intro')==='intro' ? 'btn-primary':'' ]">ç®€ä»‹</button>
                      <button @click="m._tab='people'; $forceUpdate()"
                        :class="['btn px-2 py-1', (m._tab||'intro')==='people' ? 'btn-primary':'' ]">ä¸»è¦äººç‰©</button>
                      <button @click="m._tab='works'; $forceUpdate()"
                        :class="['btn px-2 py-1', (m._tab||'intro')==='works' ? 'btn-primary':'' ]">ä»£è¡¨ä½œ</button>
                      <button @click="toggleFavStudio(name)" class="btn px-2 py-1"
                        :class="isFavStudio(name)?'btn-primary':''">{{ isFavStudio(name)?'â˜… å·²è—':'â˜† æ”¶è—' }}</button>
                    </div>
                    <div class="mt-2 text-sm">
                      <template v-if="(m._tab||'intro')==='intro'">
                        <p class="text-slate-700 dark:text-slate-300">{{ m.intro || 'æš‚æ— ç®€ä»‹' }}</p>
                      </template>
                      <template v-else-if="m._tab==='people'">
                        <ul class="list-disc ml-5 space-y-1">
                          <li v-for="p in (m.people||['â€”'])" :key="p">{{ p }}</li>
                        </ul>
                      </template>
                      <template v-else>
                        <ul class="list-disc ml-5 space-y-1">
                          <li v-for="w in (m.works||['â€”'])" :key="w">{{ w }}</li>
                        </ul>
                      </template>
                    </div>
                  </div>
                </div>
              </article>
            </div>
          </div>

          <!-- æ— ç»“æœ -->
          <div v-if="!loading && total===0 && viewMode==='grid'" class="text-center py-20 text-slate-500">
            æ²¡æœ‰ç»“æœï¼Œæ¢ä¸ªå…³é”®è¯æˆ–ç­›é€‰è¯•è¯•ï½</div>

          <!-- ======= æ–°å¢ï¼šä¸»é¡µè®¨è®ºåŒº ======= -->
          <div class="mt-14">
            <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
              <div class="flex items-center justify-between">
                <h3 class="font-bold text-lg">è®¨è®ºåŒº</h3>
                <button class="btn text-xs" @click="seedDemoPosts">ç”Ÿæˆå‡ æ¡ç¤ºä¾‹</button>
              </div>
              <!-- å‘å¸– -->
              <div class="mt-3 grid gap-2 sm:grid-cols-6">
                <input v-model.trim="forumDraft.title"
                  class="sm:col-span-2 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none"
                  placeholder="æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰">
                <input v-model.trim="forumDraft.content"
                  class="sm:col-span-3 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none"
                  placeholder="è¯´ç‚¹ä»€ä¹ˆâ€¦">
                <button class="btn btn-primary sm:col-span-1" @click="postToForum">å‘å¸ƒ</button>
              </div>
              <!-- åˆ—è¡¨ -->
              <div class="mt-4 space-y-3">
                <div v-for="p in forumPostsSorted" :key="p.id" class="card p-3">
                  <div class="flex items-center justify-between text-xs text-slate-500">
                    <div class="flex items-center gap-2">
                      <span class="avatar w-6 h-6 text-[10px]">{{ (p.user?.name||'U').slice(0,1).toUpperCase() }}</span>
                      <span class="font-medium text-slate-700 dark:text-slate-300">{{ p.user?.name || 'åŒ¿å' }}</span>
                    </div>
                    <span>{{ fmtTime(p.ts) }}</span>
                  </div>
                  <div class="mt-1">
                    <p class="font-semibold" v-if="p.title">{{ p.title }}</p>
                    <p class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap">{{ p.content }}</p>
                  </div>
                  <div class="mt-2 flex items-center gap-2 text-xs">
                    <button class="btn px-2 py-1" @click="likePost(p.id)">ğŸ‘ {{ p.likes||0 }}</button>
                  </div>
                </div>
                <div v-if="forumPosts.length===0" class="text-sm text-slate-500">è¿˜æ²¡æœ‰è®¨è®ºï¼Œæ¥å‘ç¬¬ä¸€æ¡å§ï½</div>
              </div>
            </div>
          </div>
          <!-- ======= /è®¨è®ºåŒº ======= -->

        </div>
      </main>
    </section>







    <!-- ========== æ¸¸æˆå­é¡µé¢ ========== -->
    <section v-else-if="route.startsWith('/game/')" class="max-w-6xl mx-auto px-4 py-6">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>

      <div v-if="currentGame" class="grid md:grid-cols-2 gap-5">
        <!-- å°é¢å›¾ -->
        <div class="card soft-shadow p-3">
          <img :src="coverAnime(currentGame)" class="w-full h-full object-cover rounded-xl aspect-[4/5]"
            :class="currentGame.isAdult && !ageVerified ? 'sensitive-blur' : ''" />
        </div>

        <!-- æ ‡é¢˜ + å…ƒä¿¡æ¯ + æ”¶è—/å¿«é€Ÿé¢„è§ˆï¼ˆå¯ä¿ç•™ï¼‰ -->
        <div class="card soft-shadow p-4">
          <h2 class="text-2xl font-black tracking-tight">{{ currentGame.title }}</h2>
          <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
            å‘å”®ï¼š{{ fmtDate(currentGame.releaseDate) }} Â· å¹³å°ï¼š{{ currentGame.platforms.join('/') }}
          </p>
          <p class="text-sm text-[var(--brand)] mt-1">
            åˆ¶ä½œç¤¾ï¼š<span class="cursor-pointer hover:underline"
              @click="viewMode='studios'; quickView=null;nav('#/home')">{{
              currentGame.maker }}</span>
          </p>
          <div class="mt-2 flex flex-wrap gap-2">
            <span v-for="t in currentGame.tags" :key="t" class="pill c1 text-[11px]">{{ t }}</span>
          </div>
          <div class="mt-3 flex gap-2">
            <button class="btn" :class="isFav(currentGame.id)?'btn-primary':''" @click="toggleFav(currentGame)">
              {{ isFav(currentGame.id)?'â˜… å·²è—':'â˜† æ”¶è—' }}
            </button>
            <button class="btn" @click="window.scrollTo({top:0,behavior:'smooth'})">å›åˆ°é¡¶éƒ¨</button>
          </div>
        </div>
      </div>

      <!-- ä»‹ç» -->
      <div v-if="currentGame" class="card soft-shadow p-4 mt-5">
        <h3 class="font-semibold">æ¸¸æˆä»‹ç»</h3>
        <p class="mt-2 text-sm text-slate-700 dark:text-slate-300">{{ currentGame.desc }}</p>
      </div>


      <!-- ä½œå“ç”»å»Š -->
      <div v-if="currentGame?.gallery?.length" class="card soft-shadow p-4 mt-5">
        <h3 class="font-semibold">ç”»å»Š</h3>
        <div class="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
          <img v-for="(s,i) in currentGame.gallery" :key="i" :src="s"
            class="w-full h-28 sm:h-32 object-cover rounded border border-slate-300/60 dark:border-slate-700"
            loading="lazy" />
        </div>
      </div>


      <!-- å®£ä¼ è§†é¢‘ -->
      <!-- <div v-if="currentGame" class="card soft-shadow p-4 mt-5">
        <h3 class="font-semibold">å®£ä¼ è§†é¢‘</h3>
        <video v-if="currentGame.video" class="w-full rounded-xl mt-2" controls :src="currentGame.video"></video>
        <p v-else class="text-sm text-slate-500 mt-2">æš‚æ— è§†é¢‘</p>
      </div> -->
      <!-- å®£ä¼ è§†é¢‘ -->
<div v-if="currentGame" class="card soft-shadow p-4 mt-5">
  <h3 class="font-semibold">å®£ä¼ è§†é¢‘</h3>

  <!-- èƒ½è¯†åˆ«ä¸º B ç«™åˆ™å†…åµŒæ’­æ”¾ -->
  <div v-if="embedUrl(currentGame.video)" class="aspect-video mt-2">
    <iframe :src="embedUrl(currentGame.video)"
      allow="autoplay; encrypted-media; picture-in-picture"
      referrerpolicy="no-referrer"
      loading="lazy" frameborder="0" allowfullscreen
      class="w-full h-full"></iframe>
  </div>

  <!-- å¦åˆ™è‹¥æ˜¯ç›´é“¾åª’ä½“æ–‡ä»¶å†ç”¨ <video> æ’­æ”¾ -->
  <video v-else-if="isMediaFile(currentGame.video)"
         class="w-full rounded-xl mt-2" controls autoplay muted playsinline
         :src="currentGame.video"></video>

  <p v-else class="text-sm text-slate-500 mt-2">æš‚æ— è§†é¢‘</p>
</div>


      <!-- èµ„æºé“¾æ¥ï¼ˆé”šç‚¹ï¼šresourcesï¼‰ -->
      <div v-if="currentGame" id="resources" class="card soft-shadow p-4 mt-5">
        <h3 class="font-semibold">èµ„æºé“¾æ¥</h3>
        <div class="mt-3 grid sm:grid-cols-2 gap-3">
          <a :href="currentGame.official||'#'" target="_blank"
            :class="['btn text-sm', (currentGame.official?'btn-primary':'') ]">å®˜æ–¹é“¾æ¥</a>
          <a v-if="!(currentGame.isAdult && !ageVerified)" :href="currentGame.resource||'#'" target="_blank"
            rel="noopener noreferrer" class="btn text-sm">èµ„æºé“¾æ¥</a>
          <button v-else class="btn text-sm" @click="openAgeGate=true">èµ„æºé“¾æ¥ï¼ˆéœ€æ»¡18ï¼‰</button>

        </div>
        <p class="text-xs text-slate-500 mt-2">* ç¤ºä¾‹åœ°å€ï¼Œè¯·æ›¿æ¢ä¸ºçœŸå®é“¾æ¥ã€‚</p>
      </div>


      <!-- è¯„è®ºåŒº -->
      <div v-if="currentGame" class="card soft-shadow p-4 mt-5">
        <h3 class="font-semibold">è¯„è®º</h3>
        <div class="mt-2 grid grid-cols-5 gap-2">
          <input v-model.trim="commentDraft[currentGame.id]" placeholder="å†™ä¸‹è¯„è®ºâ€¦"
            class="col-span-4 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <button class="btn btn-primary col-span-1" @click="submitComment(currentGame.id)">å‘å¸ƒ</button>
        </div>
        <div class="mt-3 space-y-2">
          <div v-for="c in commentsBy(currentGame.id)" :key="c.id" class="card p-2">
            <div class="flex items-center justify-between text-xs text-slate-500">
              <div class="flex items-center gap-2">
                <span class="avatar w-6 h-6 text-[10px]">{{ (c.user?.name||'U').slice(0,1).toUpperCase() }}</span>
                <span class="font-medium text-slate-700 dark:text-slate-300">{{ c.user?.name||'åŒ¿å' }}</span>
              </div>
              <span>{{ fmtTime(c.ts) }}</span>
            </div>
            <p class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap mt-1">{{ c.text }}</p>
          </div>
          <p v-if="commentsBy(currentGame.id).length===0" class="text-xs text-slate-500">æš‚æ— è¯„è®ºï¼Œæ¥å ä¸ªæ²™å‘å§ï½</p>
        </div>
      </div>
    </section>



    <!-- ========== èµ„æ–™é¡µ ========== -->
    <section v-else-if="route==='/profile'" class="max-w-3xl mx-auto px-4 py-8">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>
      <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
        <h2 class="text-xl font-bold">æˆ‘çš„èµ„æ–™</h2>
        <div class="mt-4 grid sm:grid-cols-3 gap-3">
          <div class="sm:row-span-2">
            <div class="avatar w-20 h-20 text-2xl overflow-hidden">
              <img v-if="profile.avatar" :src="profile.avatar" class="w-full h-full object-cover" />
              <span v-else>{{ (profile.name||'U').slice(0,1).toUpperCase() }}</span>
            </div>
            <label class="btn mt-2 inline-block">
              ä¸Šä¼ å¤´åƒ
              <input type="file" accept="image/*" class="hidden" @change="uploadAvatar">
            </label>
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm">æ˜µç§°</label>
            <input v-model.trim="profile.name"
              class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          </div>
          <div class="sm:col-span-2">
            <label class="text-sm">ç®€ä»‹</label>
            <textarea v-model.trim="profile.bio" rows="3"
              class="w-full mt-1 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none"></textarea>
          </div>
          <div class="sm:col-span-2">
            <button class="btn btn-primary" @click="saveProfile">ä¿å­˜èµ„æ–™</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== æ”¶è—é¡µ ========== -->
    <section v-else-if="route==='/favorites'" class="max-w-5xl mx-auto px-4 py-8">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>
      <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">æˆ‘çš„æ”¶è—</h2>
          <div class="flex gap-2">
            <input v-model.trim="favQ" placeholder="æœç´¢æ”¶è—â€¦"
              class="px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
            <button class="btn text-xs" @click="clearFavs">æ¸…ç©º</button>
          </div>
        </div>

        <div class="mt-4">
          <h3 class="font-semibold">æ¸¸æˆ</h3>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
            <div v-for="g in favGamesView" :key="g.id" class="card p-3 flex gap-3">
              <img :src="coverAnime(g)" class="w-20 h-24 object-cover rounded" />
              <div class="flex-1">
                <p class="font-semibold line-clamp-1 hover:underline cursor-pointer" @click="goGame(g)">{{ g.title }}
                </p>

                <p class="text-xs text-slate-500">å¹³å°ï¼š{{ g.platforms.join('/') }} Â· è¯„åˆ† {{ g.rating }}</p>
                <div class="mt-1 flex gap-2">
                  <button class="btn text-xs" @click="goGame(g)">è¯¦æƒ…</button>

                  <button class="btn text-xs" @click="toggleFav(g)">å–æ¶ˆ</button>
                </div>
              </div>
            </div>
            <p v-if="favGamesView.length===0" class="text-sm text-slate-500">æ²¡æœ‰æ”¶è—çš„æ¸¸æˆ</p>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">åˆ¶ä½œç¤¾</h3>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 mt-2">
            <div v-for="name in favStudiosView" :key="name" class="card p-3">
              <p class="font-semibold">{{ name }}</p>
              <div class="mt-2 flex gap-2">
                <button class="btn text-xs" @click="viewMode='studios'; nav('#/home')">å»å›¾é‰´çœ‹</button>
                <button class="btn text-xs" @click="toggleFavStudio(name)">å–æ¶ˆ</button>
              </div>
            </div>
            <p v-if="favStudiosView.length===0" class="text-sm text-slate-500">æ²¡æœ‰æ”¶è—çš„åˆ¶ä½œç¤¾</p>
          </div>
        </div>
      </div>
    </section>

    <!-- ========== ç™»å½• ========== -->
    <section v-else-if="route==='/login'" class="max-w-md mx-auto px-4 py-8">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>
      <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
        <h2 class="text-xl font-bold">ç™»å½•</h2>
        <div class="mt-3 space-y-3">
          <input v-model.trim="authLogin.email" type="email" placeholder="é‚®ç®±"
            class="w-full px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <input v-model.trim="authLogin.password" type="password" placeholder="å¯†ç "
            class="w-full px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <button class="btn btn-primary w-full" @click="doLogin">ç™»å½•</button>
          <p class="text-xs text-slate-500">
            æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#/register" class="underline">å»æ³¨å†Œ</a> Â·
            <a href="#/forgot" class="underline">å¿˜è®°å¯†ç </a>
          </p>

        </div>
      </div>
    </section>

    <!-- ========== æ³¨å†Œ ========== -->
    <section v-else-if="route==='/register'" class="max-w-md mx-auto px-4 py-8">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>
      <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
        <h2 class="text-xl font-bold">æ³¨å†Œ</h2>
        <div class="mt-3 space-y-3">
          <input v-model.trim="authReg.name" placeholder="æ˜µç§°"
            class="w-full px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <input v-model.trim="authReg.email" type="email" placeholder="é‚®ç®±"
            class="w-full px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <input v-model.trim="authReg.password" type="password" placeholder="å¯†ç "
            class="w-full px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <button type="button" class="btn btn-primary w-full"
            :disabled="!authReg.name || !authReg.email || !authReg.password || !isEmailVerified(authReg.email)"
            @click="doRegister">æ³¨å†Œå¹¶ç™»å½•</button>

          <!-- æ³¨å†Œï¼šé‚®ç®±éªŒè¯ç  -->
          <div class="mt-3 p-3 rounded-xl border border-slate-300/60 dark:border-slate-700/60">
            <p class="text-sm mb-2">æ¨èï¼šå…ˆéªŒè¯é‚®ç®±å†æ³¨å†Œ</p>
            <div class="flex gap-2 items-center">
              <button class="btn text-xs" :disabled="otpCooldown>0 || !authReg.email" @click="requestVerifyCode">
                {{ otpCooldown>0 ? `é‡æ–°å‘é€(${otpCooldown}s)` : 'å‘é€éªŒè¯ç ' }}
              </button>
              <input v-model.trim="verifyCode" maxlength="6" placeholder="è¾“å…¥ 6 ä½éªŒè¯ç "
                class="flex-1 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
              <button class="btn btn-primary text-xs" :disabled="verifyCode.length!==6 || !authReg.email"
                @click="submitVerifyCode">
                æäº¤éªŒè¯
              </button>
            </div>
            <p class="text-xs text-slate-500 mt-2">
              * éªŒè¯æˆåŠŸåï¼Œç›´æ¥ç‚¹â€œæ³¨å†Œå¹¶ç™»å½•â€å³å¯å®Œæˆæ³¨å†Œã€‚
            </p>
          </div>

          <p class="text-xs text-slate-500">å·²æœ‰è´¦å·ï¼Ÿ<a href="#/login" class="underline">å»ç™»å½•</a></p>
        </div>
      </div>
    </section>
    <!-- å¿˜è®°å¯†ç ï¼šå¡«å†™é‚®ç®± -->
    <section v-else-if="route==='/forgot'" class="max-w-md mx-auto px-4 py-8">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>
      <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
        <h2 class="text-xl font-bold">æ‰¾å›å¯†ç </h2>
        <div class="mt-3 space-y-3">
          <input v-model.trim="resetEmail" type="email" placeholder="æ³¨å†Œé‚®ç®±"
            class="w-full px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
          <button class="btn btn-primary w-full" @click="requestResetCode">å‘é€é‡ç½®é‚®ä»¶</button>

          <!-- å¿˜è®°å¯†ç ï¼šä½¿ç”¨éªŒè¯ç é‡ç½® -->
          <div class="mt-6 p-3 rounded-xl border border-slate-300/60 dark:border-slate-700/60">
            <p class="text-sm mb-2">æˆ–ï¼šä½¿ç”¨é‚®ç®±éªŒè¯ç é‡ç½®å¯†ç </p>
            <div class="space-y-2">
              <div class="flex gap-2">
                <input v-model.trim="resetEmail" type="email" placeholder="æ³¨å†Œé‚®ç®±"
                  class="flex-1 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
                <button class="btn text-xs" :disabled="otpCooldown>0 || !resetEmail" @click="requestResetCode">
                  {{ otpCooldown>0 ? `é‡æ–°å‘é€(${otpCooldown}s)` : 'å‘é€éªŒè¯ç ' }}
                </button>
              </div>
              <div class="flex gap-2">
                <input v-model.trim="resetCode" maxlength="6" placeholder="éªŒè¯ç "
                  class="w-32 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-white/70 dark:bg-white/10 text-sm outline-none" />
                <input v-model.trim="newPassword" type="password" placeholder="æ–°å¯†ç "
                  class="flex-1 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-white/70 dark:bg-white/10 text-sm outline-none" />
                <button class="btn btn-primary text-xs" :disabled="!resetEmail || resetCode.length!==6 || !newPassword"
                  @click="resetByCode">
                  ç”¨éªŒè¯ç é‡ç½®
                </button>
              </div>
            </div>
          </div>

          <p class="text-xs text-slate-500">å·²æ”¶åˆ°é‚®ä»¶ï¼Ÿç‚¹å‡»é‚®ç®±ä¸­çš„é“¾æ¥ç»§ç»­ã€‚</p>
        </div>
      </div>
    </section>

    <!-- é‚®ç®±éªŒè¯è½åœ°ï¼šå¸¦ token -->
    <section v-else-if="route.startsWith('/verify')" class="max-w-md mx-auto px-4 py-8">
      <a href="#/home" class="back-link btn mb-4">â† å›åˆ°ä¸»é¡µ</a>
      <div class="glass soft-shadow ring-grad p-4 rounded-2xl">
        <h2 class="text-xl font-bold">éªŒè¯é‚®ç®±</h2>
        <p class="mt-2 text-sm">æ­£åœ¨éªŒè¯ä¸­â€¦</p>
      </div>
    </section>

    <!-- é¡µè„šï¼ˆä¿æŒä¸åŠ¨ï¼‰ -->
    <footer id="about" class="mt-auto glass soft-shadow border-t border-white/50 dark:border-slate-700/50">
      <div class="max-w-7xl mx-auto px-4 py-8 grid gap-4 md:grid-cols-2 text-sm text-slate-700/90 dark:text-slate-400">
        <div>
          <p class="font-semibold text-slate-900 dark:text-white">åˆè§„ä¸å£°æ˜</p>
          <p class="mt-2">æœ¬é¡µé¢ä¸ºèµ„æºåˆ†äº«ç«™ç‚¹ï¼Œä»…èšåˆç™¾ç§‘/è¯„æµ‹/å…¬å‘Š/æ”»ç•¥ç­‰èµ„æ–™ï¼Œä¸å¼€å‘ä»»ä½•ã€ç ´è§£æˆ–ä¾µæƒèµ„æºã€‚è‹¥æœ‰æƒåˆ©é—®é¢˜ï¼Œè¯·é€šè¿‡ QQ é‚®ç®±è”ç³»ï¼š1543252798@@qq.comã€‚</p>
        </div>
        <div>
          <p class="font-semibold text-slate-900 dark:text-white">å¼€æºä¸æŠ€æœ¯</p>
          <p class="mt-2">å‰ç«¯ï¼šVue 3 + Tailwindï¼›æ„Ÿè°¢BiliBili,AcgDOG,vndb,Bangumiç­‰æä¾›çš„ç›¸å…³èµ„æºå’Œä¿¡æ¯ï¼Œä¹Ÿæ„Ÿè°¢Key,Innocent Grey,TYPE-MOON,MIONORIç­‰åˆ¶ä½œç¤¾çš„ä¼˜è´¨ä½œå“ï¼ŒåŒæ—¶æ„Ÿè°¢æ‰€æœ‰çƒ­çˆ±Galçš„Userså’Œå¯¹æ­¤ç½‘ç«™æ”¯æŒã€‚</p>
        </div>
      </div>
    </footer>

    <!-- å¹´é¾„éªŒè¯ -->
    <div v-if="openAgeGate" class="fixed inset-0 z-40 bg-black/50 grid place-items-center p-4"
      @keydown.escape="openAgeGate=false">
      <div class="glass max-w-md w-full rounded-2xl p-5 soft-shadow">
        <h3 class="text-lg font-semibold">å¹´é¾„éªŒè¯</h3>
        <p class="text-sm text-slate-700/90 dark:text-slate-400 mt-1">æœ¬ç«™å« R-18 ä½œå“èµ„æ–™ã€‚è‹¥ä½ å·²å¹´æ»¡ 18 å²ï¼Œå¯ç»§ç»­æµè§ˆå¹¶æ˜¾ç¤ºç›¸å…³å†…å®¹ã€‚</p>
        <div class="mt-4 flex items-center gap-3">
          <button @click="confirmAdult(true)" class="btn btn-primary flex-1">æˆ‘å·²å¹´æ»¡ 18 å²</button>
          <button @click="confirmAdult(false)" class="btn flex-1">ä»ä»¥æœªæˆå¹´è§†å›¾æµè§ˆ</button>
        </div>
      </div>
    </div>

    <!-- å¿«é€Ÿè¯¦æƒ… + è¯„è®ºåŒº -->
    <div v-if="quickView" class="fixed inset-0 z-40 bg-black/50 grid place-items-center p-4"
      @click.self="quickView=null" @keydown.escape="quickView=null">
      <div class="glass max-w-3xl w-full rounded-2xl overflow-hidden soft-shadow">
        <div class="grid grid-cols-1 md:grid-cols-2">
          <div class="relative bg-slate-100 dark:bg-slate-800">
            <img :src="coverAnime(quickView)" class="block   w-full  object-cover aspect-[4/5]"
              :class="quickView.isAdult && !ageVerified ? 'sensitive-blur' : ''" loading="lazy" />
            <div class="p-2">
              <div class="grid gap-2 [grid-template-columns:repeat(auto-fit,minmax(6rem,1fr))]">
                <img v-for="(s,i) in quickView.gallery || []" :key="i" :src="s"
                  class="h-16 w-full object-cover rounded border border-slate-300/60 dark:border-slate-700" />
              </div>
            </div>

          </div>
          <div class="p-4">
            <h3 class="text-xl font-bold">{{ quickView.title }}</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400">å‘å”®ï¼š{{ fmtDate(quickView.releaseDate) }} Â· å¹³å°ï¼š{{
              quickView.platforms.join('/') }}</p>
            <p class="text-sm text-[var(--brand)] mt-1">åˆ¶ä½œç¤¾ï¼š<span class="cursor-pointer hover:underline"
                @click="viewMode='studios'; quickView=null; nav('#/home')">{{ quickView.maker }}</span></p>
            <p class="mt-2 text-sm text-slate-700 dark:text-slate-300">{{ quickView.desc }}</p>
            <div class="mt-3 flex flex-wrap gap-2">
              <span v-for="t in quickView.tags" :key="t"
                class="text-[11px] px-2 py-0.5 rounded-full border border-slate-300/60 dark:border-slate-700">#{{ t
                }}</span>
            </div>
            <div class="mt-4">
              <p class="text-sm mb-1">ä½ çš„è¯„åˆ†ï¼š</p>
              <div class="flex items-center gap-1">
                <button v-for="s in 10" :key="s" @click="rate(quickView.id, s)" class="text-lg">{{ getRate(quickView.id)
                  >= s ? 'â˜…' : 'â˜†' }}</button>
                <span class="ml-2 text-xs text-slate-500">å·²å­˜æœ¬åœ°</span>
              </div>
            </div>
            <div class="mt-4 grid grid-cols-3 gap-2">
              <button class="btn" @click="goGame(quickView,'resources'); quickView=null">èµ„æº</button>
              <button class="btn" @click="quickView=null">å…³é—­</button>
              <button class="btn" :class="isFav(quickView.id)?'btn-primary':''" @click="toggleFav(quickView)">{{
                isFav(quickView.id)?'â˜… å·²è—':'â˜† æ”¶è—' }}</button>
            </div>
            <!-- è¯„è®ºåŒº -->
            <div class="mt-5">
              <h4 class="font-semibold text-sm">è¯„è®º</h4>
              <div class="mt-2 grid grid-cols-5 gap-2">
                <input v-model.trim="commentDraft[quickView.id]" placeholder="å†™ä¸‹è¯„è®ºâ€¦"
                  class="col-span-4 px-3 py-2 rounded-lg border border-slate-300/60 dark:border-slate-700 bg-transparent text-sm outline-none" />
                <button class="btn btn-primary col-span-1" @click="submitComment(quickView.id)">å‘å¸ƒ</button>
              </div>
              <div class="mt-3 space-y-2 max-h-56 overflow-y-auto pr-1">
                <div v-for="c in commentsBy(quickView.id)" :key="c.id" class="card p-2">
                  <div class="flex items-center justify-between text-xs text-slate-500">
                    <div class="flex items-center gap-2">
                      <span class="avatar w-6 h-6 text-[10px]">{{ (c.user?.name||'U').slice(0,1).toUpperCase() }}</span>
                      <span class="font-medium text-slate-700 dark:text-slate-300">{{ c.user?.name||'åŒ¿å' }}</span>
                    </div>
                    <span>{{ fmtTime(c.ts) }}</span>
                  </div>
                  <p class="text-sm text-slate-700 dark:text-slate-300 whitespace-pre-wrap mt-1">{{ c.text }}</p>
                </div>
                <p v-if="commentsBy(quickView.id).length===0" class="text-xs text-slate-500">æš‚æ— è¯„è®ºï¼Œæ¥å ä¸ªæ²™å‘å§ï½</p>
              </div>
            </div>
            <!-- /è¯„è®ºåŒº -->

          </div>
        </div>
      </div>
    </div>

  </div><!-- /#app -->

  <script>
    const { createApp, ref, computed, onMounted, watch } = Vue;

    /* èƒŒæ™¯å›¾ç‰‡ï¼ˆå¯æ›¿æ¢æˆä½ çš„ ACG CDNï¼‰ */
    const BG_IMAGES = [
      "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1549880338-65ddcdfd017b?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1511185307590-3c29c1122f83?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=80&w=1600&auto=format&fit=crop",
      "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1600&auto=format&fit=crop"
    ];



    function pickBgOnce() {
      const saved = localStorage.getItem('bg_pick');
      if (saved) return saved;
      const pick = BG_IMAGES[Math.floor(Math.random() * BG_IMAGES.length)];
      localStorage.setItem('bg_pick', pick);
      return pick;
    }
    function applyBg(url) {
      document.documentElement.style.setProperty('--photo-url', `url("${url}")`);
    }
    function changeBackground() {
      localStorage.removeItem('bg_pick');
      const next = pickBgOnce();
      applyBg(next);
      // è§¦å‘ä¸€æ¬¡æ»šåŠ¨è®¡ç®—ï¼Œç«‹åˆ»åˆ·æ–°æ¸å˜
      window.dispatchEvent(new Event('scroll'));
    }



    function mountDynamicBackground() {
      //å…³é”®ï¼šçœŸæ­£è®¾ç½®èƒŒæ™¯ï¼Œå¹¶ç¡®ä¿åˆ·æ–°/åˆ‡é¡µä¸€è‡´
      //applyBg(pickBgOnce());

      let ticking = false;
      const update = () => {
        ticking = false;
        const h = document.documentElement;
        const max = Math.max(1, h.scrollHeight - h.clientHeight);
        const p = Math.min(1, Math.max(0, window.scrollY / max)); // 0~1
        const p2 = (Math.sin(p * Math.PI) + 1) / 2; // ä¸­æ®µå¢å¼º
        const p3 = (Math.cos(p * Math.PI * 1.5) + 1) / 2; // èŠ‚å¥å±‚æ¬¡
        const x1 = 18 + 36 * p;
        const y1 = -8 + 32 * p;
        const x2 = 84 - 26 * p;
        const y2 = 2 + 20 * p2;
        const a1 = 110 + 180 * p;
        const a2 = 200 + 210 * p3;
        const root = document.documentElement.style;
        root.setProperty('--p', p.toFixed(4));
        root.setProperty('--x1', x1 + '%');
        root.setProperty('--y1', y1 + '%');
        root.setProperty('--x2', x2 + '%');
        root.setProperty('--y2', y2 + '%');
        root.setProperty('--a1', a1 + 'deg');
        root.setProperty('--a2', a2 + 'deg');
      };
      window.addEventListener('scroll', () => { if (!ticking) { ticking = true; requestAnimationFrame(update); } }, { passive: true });
      update();
    }


    /* åˆ¶ä½œç¤¾å›¾é‰´ï¼ˆå¯ç»§ç»­æ‰©å±•ï¼‰ */
    const STUDIOS = {
      "Innocent Grey": {
        founded: "2004",
        intro: "ä»¥æ‚¬ç–‘/æ¨ç†ä¸æˆäººé¢˜æè§é•¿ï¼Œæ°›å›´é˜´ç¿³ï¼Œç¾æœ¯ç²¾è‡´å†™å®ï¼Œæ“…é•¿é»‘æš—ç¾¤åƒä¸æ˜­å’ŒèƒŒæ™¯ã€‚",
        people: ["æ‰èœæ°´å§¬ï¼ˆåŸç”»ï¼‰", "ã—ã¾ã©ã‚Šã‚‹ï¼ˆå‰§æœ¬å‚ä¸ï¼‰"],
        works: ["æ®»ãƒå°‘å¥³", "Cartagra", "FLOWERS ç³»åˆ—"]
      },
      "Key": {
        founded: "1998",
        intro: "â€œæ³ªç›®ç³»â€æ ‡å¿—å“ç‰Œï¼Œä»¥æ¸©æƒ…ä¸æ²»æ„ˆè§é•¿ï¼ŒéŸ³ä¹/æ¼”å‡ºæ„ŸæŸ“åŠ›å¼ºï¼Œç¾¤åƒå¡‘é€ ç«‹ä½“ã€‚",
        people: ["éº»æå‡†ï¼ˆå‰§æœ¬/æ›²ï¼‰", "Na-Gaï¼ˆåŸç”»ï¼‰"],
        works: ["CLANNAD", "Little Busters!", "Rewrite"]
      },
      "TYPE-MOON": {
        founded: "2000",
        intro: "å®å¤§å¥‡å¹»è®¾å®šä¸ä¸–ç•Œè§‚å¡‘é€ ï¼Œäººç‰©ç¾¤åƒé²œæ˜ï¼Œè·¨åª’ä»‹å½±å“åŠ›å¼ºã€‚",
        people: ["å¥ˆé¡»è˜‘è‡ï¼ˆå‰§æœ¬ï¼‰", "æ­¦å†…å´‡ï¼ˆåŸç”»ï¼‰"],
        works: ["Fate/stay night", "æœˆå§¬", "ç©ºä¹‹å¢ƒç•Œï¼ˆç›¸å…³ï¼‰"]
      },
      "Nitroplus": {
        founded: "2000",
        intro: "é»‘æš—ç§‘å¹»ã€æš´åŠ›ç¾å­¦ã€ä¸å®éªŒæ€§å™äº‹å¹¶é‡ã€‚",
        people: ["è™šæ¸Šç„", "çŸ³æ¸¡ãƒã‚³ãƒˆ"],
        works: ["è£…ç”²æ¶é¬¼æ‘æ­£", "Phantom", "STEINS;GATEï¼ˆååŠ›ï¼‰"]
      },
      "Frontwing": {
        founded: "1999",
        intro: "å•†ä¸šåŒ–ç¨‹åº¦é«˜çš„å“ç‰Œï¼Œä»£è¡¨ä½œä¸ºã€Šç°è‰²ã€‹ç³»åˆ—ã€‚",
        people: ["æ¸¡è¾¹æ˜å¤«ï¼ˆåˆä½œï¼‰", "è—¤å´ç”±çˆ±ï¼ˆåˆä½œï¼‰"],
        works: ["ç°è‰²çš„æœå®/è¿·å®«/ä¹å›­"]
      },
      "minori": {
        founded: "2001",
        intro: "ç”»é¢æ¼”å‡ºå’Œç¾æœ¯æä¸ºç²¾è‡´ï¼Œå·²åœæ­¢æ´»åŠ¨ä½†ä½œå“å½±å“æ·±è¿œã€‚",
        people: ["é…’äº•ä¼¸å’Œ", "å¾¡å½±"],
        works: ["ef - a fairy tale of the two.", "eden*", "ã¯ã‚‹ã®ã‚ã—ãŠã¨"]
      },
      "Alicesoft": {
        founded: "1989",
        intro: "å†å²æ‚ ä¹…çš„æˆäººå‘å“ç‰Œï¼Œæˆ˜æ–—ä¸ç»è¥ç³»ç»Ÿè§é•¿ã€‚",
        people: ["ãŠã«ãã‚Šãã‚“", "é›·å¤ª"],
        works: ["å…°æ–¯ç³»åˆ—", "å¤§å¸å›½", "è¶…æ˜‚å¤©ä½¿"]
      }
    };

    /* å ä½å°é¢ï¼ˆä¸Šçº¿æ¢ä½ çš„ CDNï¼‰ */
    const coverAnimeUrl = (text) => `https://placehold.co/640x800/png?font=roboto&text=${encodeURIComponent(text)}&background=111827&foreground=ffffff`;
    const bannerAnimeUrl = (text) => `https://placehold.co/1200x480/png?font=roboto&text=${encodeURIComponent(text)}&background=0b1324&foreground=ffffff`;
    const galleryAnimeUrl = (text) => `https://placehold.co/640x360/png?font=roboto&text=${encodeURIComponent(text)}&background=0f172a&foreground=ffffff`;


    /* è®¨è®ºåŒº/è¯„è®º çš„ç®€æ˜“ id */
    const uid = () => Math.random().toString(36).slice(2, 10);

    createApp({
      setup() {
        // === æ”¾åœ¨ setup() é¡¶éƒ¨ã€å’Œ otpCooldown/otpTimer åŒä¸€ä½œç”¨åŸŸ ===
        function startOtpCooldown(sec = 60) {
          otpCooldown.value = sec;
          clearInterval(otpTimer);
          otpTimer = setInterval(() => {
            otpCooldown.value--;
            if (otpCooldown.value <= 0) { clearInterval(otpTimer); otpTimer = null; }
          }, 1000);
        }

        const avatarOpen = ref(false);
        document.addEventListener('click', () => (avatarOpen.value = false));

        // æ”¾åœ¨ setup() é¡¶éƒ¨å…¶å®ƒ ref æ—è¾¹
        const verifiedEmails = ref(new Set(JSON.parse(localStorage.getItem('otp_verified') || '[]')));
        function isEmailVerified(email) {
          return !!email && verifiedEmails.value.has(email.trim().toLowerCase());
        }
        function markEmailVerified(email) {
          if (!email) return;
          verifiedEmails.value.add(email.trim().toLowerCase());
          localStorage.setItem('otp_verified', JSON.stringify([...verifiedEmails.value]));
        }



        const fuse = ref(null);         // Fuse å®ä¾‹
        let searchDebounce = null;      // é˜²æŠ–è®¡æ—¶å™¨

        function debouncedApply(delay = 160) {
          if (searchDebounce) clearTimeout(searchDebounce);
          searchDebounce = setTimeout(() => applyFilters(), delay);
        }
        function firstCoverOf(name) {
          const g = source.value.find(x => (x.maker || '').trim() === name.trim() && x.coverUrl);
          return g?.coverUrl || '';
        }

        // è½»è·¯ç”±
        function getRoute() {
          // ä¼˜å…ˆç”¨ hashï¼ˆ#/game/f8ï¼‰
          if (location.hash) return location.hash.slice(1);

          // å…œåº•ï¼šå…¼å®¹æ—  hash çš„ /game/ID
          const m = location.pathname.match(/\/game\/([^/]+)$/);
          return m ? `/game/${m[1]}` : '/home';
        }

        const route = ref(getRoute());

        function syncRoute() { route.value = getRoute(); }
        window.addEventListener('hashchange', syncRoute);
        window.addEventListener('popstate', syncRoute);
        window.addEventListener('popstate', scrollIfAnchor, { passive: true });


        // å–è·¯ç”±å‚æ•°ï¼Œå¦‚ /game/f3 -> id=f3
        function routeParam() {
          // å½¢å¦‚ "#/game/f8?to=resources"
          let raw = location.hash;

          // æ—  hashï¼šä» pathname + search å…œåº•ï¼Œå¹¶æŠŠå®ƒâ€œè½¬æˆâ€ç­‰ä»·çš„ hash å½¢å¼
          if (!raw) {
            const m = location.pathname.match(/\/game\/([^/?#]+)$/);
            const search = location.search.replace(/^\?/, ''); // å…¼å®¹ ?to=resources
            raw = m ? `#/game/${m[1]}${search ? `?${search}` : ''}` : '#/home';
          }

          const [path, query = ''] = raw.slice(1).split('?');
          const parts = path.split('/'); // ["", "game", "f8"]
          const q = Object.fromEntries(new URLSearchParams(query));
          return { parts, q };
        }

        function nav(hash) { location.hash = hash; }


        const currentGame = computed(() => {
          const { parts } = routeParam();      // <- ç”¨ä½ çš„è§£æå‡½æ•°
          if (parts[1] !== 'game') return null;
          const id = parts[2];                 // å·²ç»æ˜¯â€œf8â€ï¼Œä¸ä¼šå¸¦ ?to=resources
          return source.value.find(g => g.id === id) || null;
        });


        // è·³åˆ°å­é¡µé¢ï¼ˆå¯å¸¦é”šç‚¹ï¼š'resources'ï¼‰
        function goGame(g, anchor) {
          const id = typeof g === 'string' ? g : g.id;
          const q = anchor ? (`?to=${anchor}`) : '';
          nav(`#/game/${id}${q}`);
        }




        // ç”¨æˆ· & Auth
        const user = ref(JSON.parse(localStorage.getItem('gl_user') || 'null')); // {email, name, avatar, bio}
        const profile = ref({ name: user.value?.name || 'User', bio: user.value?.bio || '', avatar: user.value?.avatar || '' });
        const isLoggedIn = computed(() => !!user.value);

        // é¡¶éƒ¨å³ä¾§ç”¨æˆ·å…¥å£ï¼ˆDOMç›´æ§ï¼‰
        function refreshUserEntry() {
          const out = document.getElementById('userLoggedOut');
          const inx = document.getElementById('userLoggedIn');
          if (!out || !inx) return;
          if (isLoggedIn.value) {
            out.classList.add('hidden'); inx.classList.remove('hidden');
            const img = document.getElementById('avatarImg');
            const ini = document.getElementById('avatarInitial');
            if (user.value?.avatar) {
              img.src = user.value.avatar; img.classList.remove('hidden'); ini.classList.add('hidden');
            } else {
              ini.textContent = (user.value?.name || 'U').slice(0, 1).toUpperCase(); img.classList.add('hidden'); ini.classList.remove('hidden');
            }
          } else {
            out.classList.remove('hidden'); inx.classList.add('hidden');
          }
        }
        function bindAvatarMenu() {
          const btn = document.getElementById('avatarBtn');
          const menu = document.getElementById('avatarMenu');
          const logoutBtn = document.getElementById('logoutBtn');
          if (btn) {
            btn.onclick = () => menu.classList.toggle('hidden');
            document.addEventListener('click', (e) => {
              if (!menu) return;
              if (!e.target.closest('#avatarBtn') && !e.target.closest('#avatarMenu')) menu.classList.add('hidden');
            });
          }
          if (logoutBtn) {
            logoutBtn.onclick = async () => {
              await doLogout();           // èµ°æ¥å£ç‰ˆé€€å‡ºï¼Œæ¸…æœåŠ¡ç«¯ä¼šè¯ + å›åˆ°é¦–é¡µ
              menu?.classList.add('hidden'); // æŠŠå¤´åƒèœå•æ”¶èµ·æ¥ï¼Œé¿å…æ‚¬ç©º
            };
          }

        }

        // æ”¾åˆ° setup() é‡Œï¼Œæ›¿æ¢æ‰æ—§çš„ isDark/applyDark/toggleDark
        const media = window.matchMedia('(prefers-color-scheme: dark)');
        const THEME_KEY = 'theme'; // 'system' | 'dark' | 'light'

        const pref = Vue.ref(localStorage.getItem(THEME_KEY) || 'system');
        const isDark = Vue.computed(() => pref.value === 'dark' || (pref.value === 'system' && media.matches));

        function applyTheme() {
          document.documentElement.classList.toggle('dark', isDark.value);
          localStorage.setItem(THEME_KEY, pref.value);
        }

        // â‘  ç¬¬ä¸€æ¬¡æ˜ç¡®å†™å…¥ systemï¼Œé¿å… null æƒ…å†µ
        if (localStorage.getItem(THEME_KEY) == null) {
          localStorage.setItem(THEME_KEY, 'system');
        }

        // â‘¡ è¿›é¡µå°±æŒ‰å½“å‰åå¥½åº”ç”¨ä¸€æ¬¡
        applyTheme();

        // â‘¢ è·Ÿéšç³»ç»Ÿ + è·¨æ ‡ç­¾åŒæ­¥
        media.addEventListener?.('change', () => { if (pref.value === 'system') applyTheme(); });
        window.addEventListener('storage', (e) => {
          if (e.key === THEME_KEY) {
            pref.value = localStorage.getItem(THEME_KEY) || 'system';
            applyTheme();
          }
        });


        function toggleDark() { // ç»‘å®šåœ¨æŒ‰é’®ä¸Š
          pref.value = pref.value === 'system' ? 'dark' : pref.value === 'dark' ? 'light' : 'system';
          applyTheme();
        }

        // åŸºæœ¬çŠ¶æ€
        const q = ref(localStorage.getItem('q') || '');
        const openAgeGate = ref(false);
        const ageVerified = ref(localStorage.getItem('ageVerified') === '1');
        const quickView = ref(null);
        const showNav = ref(false);
        const loading = ref(true);
        const viewMode = ref('grid');

        const platforms = ['PC', 'Switch', 'PS4', 'PS5', 'PSV'];
        const tagPool = ['æ ¡å›­', 'æ‹çˆ±', 'ç¾¤åƒ', 'æ²»æ„ˆ', 'æ—¥å¸¸', 'ç§‘å¹»', 'è§£è°œ', 'æ‚¬ç–‘', 'R-18', 'å‰§æƒ…', 'ç™¾åˆ', 'æ¨ç†', 'æˆ˜æ–—', 'å¥‡å¹»', 'æç¬‘', 'æ—¶é—´ç©¿è¶Š', 'é»‘æš—'];

        const filters = ref(JSON.parse(localStorage.getItem('filters') || '{"platform":"","sort":"-date","tags":[]}'));

        const source = ref([]);
        const view = ref([]);

        // å¹´ä»½èŒƒå›´ï¼ˆè®¡ç®— + æœ¬åœ°å­˜å‚¨ï¼‰
        const years = computed(() => source.value.map(g => new Date(g.releaseDate).getFullYear()));
        const minYear = computed(() => Math.min(...years.value));
        const maxYear = computed(() => Math.max(...years.value));
        const savedYR = JSON.parse(localStorage.getItem('yearRange') || 'null');
        const yearRange = ref(savedYR && savedYR.length === 2 ? savedYR : [minYear, maxYear]);

        // åˆ†é¡µï¼ˆç½‘æ ¼ï¼‰
        const pageSize = ref(12);
        const page = ref(Number(localStorage.getItem('page') || 1));
        const pages = computed(() => Math.max(1, Math.ceil(view.value.length / pageSize.value)));
        const total = computed(() => view.value.length);
        const pageView = computed(() =>
          view.value.slice((page.value - 1) * pageSize.value, page.value * pageSize.value)
        );

        // æ•°å­—åˆ†é¡µï¼ˆ1/2/3â€¦ å¸¦çœç•¥å·ï¼‰
        const pageNumbers = computed(() => {
          const res = [];
          const totalPages = pages.value;
          const cur = page.value;
          const push = (n) => res.push({ key: 'p' + res.length, num: n });
          if (totalPages <= 10) {
            for (let i = 1; i <= totalPages; i++) push(i);
            return res;
          }
          push(1);
          if (cur > 4) push('â€¦');
          for (let i = Math.max(2, cur - 2); i <= Math.min(totalPages - 1, cur + 2); i++) push(i);
          if (cur < totalPages - 3) push('â€¦');
          push(totalPages);
          return res.map((n, i) => ({ num: n, key: 'p' + i }));
        });

        // æ”¶è—/è¯„åˆ†ï¼ˆæ¸¸æˆ + åˆ¶ä½œç¤¾ï¼‰
        const favSet = ref(new Set(JSON.parse(localStorage.getItem('favs') || '[]'))); // æ¸¸æˆID
        const favStudios = ref(new Set(JSON.parse(localStorage.getItem('fav_studios') || '[]'))); // åˆ¶ä½œç¤¾å
        const myRates = ref(JSON.parse(localStorage.getItem('rates') || '{}'));

        async function toggleFav(g) {
          const id = typeof g === 'string' ? g : g.id;
          if (!auth.value?.loggedIn) {
            if (favSet.value.has(id)) favSet.value.delete(id); else favSet.value.add(id);
            localStorage.setItem('favs', JSON.stringify([...favSet.value]));
            return;
          }
          const liked = favSet.value.has(id);
          const r = liked
            ? await api(`/favorites/games/${encodeURIComponent(id)}`, { method: 'DELETE' })
            : await api('/favorites/games', { method: 'POST', body: JSON.stringify({ id }) });
          if (r.ok) await refreshFavoritesFromServer();
        }



        async function migrateLocalFavsOnce() {
          if (localStorage.getItem('migrated')) return;
          const r = await api('/favorites');
          if (!r.ok) return;
          const data = await r.json();
          const serverG = new Set(data.games || []);
          const serverS = new Set(data.studios || []);

          const localG = JSON.parse(localStorage.getItem('favs') || '[]');
          const localS = JSON.parse(localStorage.getItem('fav_studios') || '[]');

          const addG = localG.filter(id => !serverG.has(id));
          const addS = localS.filter(nm => !serverS.has(nm));

          await Promise.all([
            ...addG.map(id => api('/favorites/games', { method: 'POST', body: JSON.stringify({ id }) })),
            ...addS.map(nm => api('/favorites/studios', { method: 'POST', body: JSON.stringify({ name: nm }) }))
          ]);

          // æˆåŠŸä¸€æ¬¡å°±ä¸å†é‡å¤
          localStorage.setItem('migrated', '1');
        }


        async function refreshFavoritesFromServer() {
          const r = await api('/favorites');
          if (!r.ok) return;
          const data = await r.json();
          favSet.value = new Set(data.games || []);
          favStudios.value = new Set(data.studios || []);
        }


        function isFav(id) { return favSet.value.has(id); }

        function toggleFavStudio(name) {
          if (favStudios.value.has(name)) favStudios.value.delete(name);
          else favStudios.value.add(name);
          localStorage.setItem('fav_studios', JSON.stringify([...favStudios.value]));
        }
        function isFavStudio(name) { return favStudios.value.has(name); }

        function rate(id, s) { myRates.value[id] = s; localStorage.setItem('rates', JSON.stringify(myRates.value)); }
        function getRate(id) { return myRates.value[id] || 0; }

        // æ—¶é—´çº¿æ´¾ç”Ÿ
        const timelineMap = computed(() => {
          const map = {};
          for (const g of view.value) {
            const y = new Date(g.releaseDate).getFullYear();
            (map[y] ||= []).push(g);
          }
          Object.values(map).forEach(arr => arr.sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate)));
          return map;
        });
        const timelineYears = computed(() => Object.keys(timelineMap.value).sort((a, b) => b - a));

        // åˆ¶ä½œç¤¾å›¾é‰´è§†å›¾
        const studios = ref({});
        const studioQ = ref('');
        const studioSort = ref('name');
        const studioView = computed(() => {
          const entries = Object.entries(studios.value).filter(([name, m]) => {
            const hay = [name, (m.intro || ''), ...(m.people || []), ...(m.works || [])].join(' ').toLowerCase();
            return !studioQ.value || hay.includes((studioQ.value || '').toLowerCase());
          });
          entries.sort((a, b) => {
            if (studioSort.value === 'name') return a[0].localeCompare(b[0], 'zh-Hans-CN');
            if (studioSort.value === 'founded') return Number((a[1].founded || 0)) - Number((b[1].founded || 0));
            if (studioSort.value === 'works') return (b[1].works?.length || 0) - (a[1].works?.length || 0);
            return 0;
          });
          return Object.fromEntries(entries);
        });

        // è¿‡æ»¤
        const normalize = s => (s || '').toLowerCase();
        function inYearRange(g) {
          const y = Number(new Date(g.releaseDate).getFullYear());
          return y >= yearRange.value[0] && y <= yearRange.value[1];
        }
        // æ¥å— overrideQï¼šå½“æœ‰ä¼ å€¼æ—¶ï¼Œç”¨å®ƒåšåŒ¹é…ï¼›å¦åˆ™ç”¨ q.value
        function applyFilters(overrideQ) {
          const needle = String((overrideQ ?? q.value) || '')
            .trim()
            .toLowerCase();
          let base = source.value;
          if (needle && fuse.value) {
            base = fuse.value.search(needle).slice(0, 300).map(r => r.item);
          }

          let arr = base.filter(g => {           // â† ç”¨ base
            const hitPlat = !filters.value.platform || g.platforms.includes(filters.value.platform);
            const hitTags = filters.value.tags.length === 0 || filters.value.tags.every(t => g.tags.includes(t));
            const y = Number(new Date(g.releaseDate).getFullYear());
            const inYear = y >= yearRange.value[0] && y <= yearRange.value[1];
            return hitPlat && hitTags && inYear; // å·²ç”¨ Fuse å‘½ä¸­ï¼Œä¸å†åš includes å¤ç­›
          });


          switch (filters.value.sort) {
            case '-rating': arr.sort((a, b) => b.rating - a.rating); break;
            case '-date': arr.sort((a, b) => new Date(b.releaseDate) - new Date(a.releaseDate)); break;
            case 'title': arr.sort((a, b) => a.title.localeCompare(b.title, 'zh-Hans-CN')); break;
            default: arr.sort((a, b) => b.hot - a.hot);
          }

          view.value = arr;
          if ((page.value - 1) * pageSize.value >= arr.length) page.value = 1;
        }

        function resetFilters() {
          q.value = '';
          filters.value = { platform: '', sort: '-hot', tags: [] };
          yearRange.value = [minYear, maxYear];
          page.value = 1; applyFilters();
        }
        function resetYears() { yearRange.value = [minYear, maxYear]; applyFilters(); }
        function toggleTag(t) { const i = filters.value.tags.indexOf(t); if (i >= 0) filters.value.tags.splice(i, 1); else filters.value.tags.push(t); page.value = 1; applyFilters(); }
        function fixYearOrder(which) {
          const [a, b] = yearRange.value;
          if (which === 'min' && a > b) yearRange.value = [b, b];
          if (which === 'max' && b < a) yearRange.value = [a, a];
          applyFilters();
        }

        // å·¥å…·
        function fmtDate(d) { try { return new Date(d).toISOString().slice(0, 10) } catch { return d } }
        function fmtTime(ts) {
          const diff = Date.now() - ts;
          const m = Math.floor(diff / 60000);
          if (m < 1) return 'åˆšåˆš';
          if (m < 60) return `${m} åˆ†é’Ÿå‰`;
          const h = Math.floor(m / 60);
          if (h < 24) return `${h} å°æ—¶å‰`;
          const d = Math.floor(h / 24);
          if (d < 7) return `${d} å¤©å‰`;
          const dt = new Date(ts);
          return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}`;
        }
        function confirmAdult(ok) { ageVerified.value = !!ok; localStorage.setItem('ageVerified', ok ? '1' : '0'); openAgeGate.value = false; }
        function openQuickViewFn(g) { quickView.value = JSON.parse(JSON.stringify(g)); }
        function toPage(p) {
          page.value = Math.min(Math.max(1, p), pages.value);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // è·³è½¬ï¼ˆå•†åº—ï¼‰
        function openGameLink(g, kind) {
          const block = g.isAdult && !ageVerified.value;
          if (block) { openAgeGate.value = true; return; }
          if (kind === 'store') { if (g.store?.url) window.open(g.store.url, '_blank'); }
        }

        // å ä½å›¾
        function coverAnime(g) {
          if (g.coverUrl) return g.coverUrl;
          const tag = (g.tags && g.tags[0]) ? g.tags[0] : 'Galgame';
          return coverAnimeUrl(`${tag}%0A${g.title}`);
        }
        function galleryAnime(g, i) {
          if (g.gallery && g.gallery[i]) return g.gallery[i];
          const tag = (g.tags && g.tags[i % g.tags.length]) ? g.tags[i % g.tags.length] : 'CG';
          return galleryAnimeUrl(`${tag}`);
        }
        function bannerCandidates(name, m) {
          const slug = (m?.slug) || name.toLowerCase().replace(/\s+/g, '-');
          const cand = [];
          if (m?.banner) cand.push(m.banner); // æ˜¾å¼é…ç½®ä¼˜å…ˆ
          cand.push(
            `assets/img/studios/${slug}/banner.webp`,
            `assets/img/studios/${slug}/banner.jpg`,
            `assets/img/studios/${slug}/banner.png`
          );
          return cand;
        }

        // ======= è¯„è®ºï¼ˆæŒ‰ä½œå“IDå­˜å‚¨ï¼‰ =======
        const comments = ref(JSON.parse(localStorage.getItem('comments') || '{}')); // {gameId: [{id, ts, text, user}]}
        const commentDraft = ref({});
        function commentsBy(id) { return comments.value[id] || []; }
        function submitComment(id) {
          const text = (commentDraft.value[id] || '').trim();
          if (!text) return;
          const item = { id: uid(), ts: Date.now(), text, user: user.value ? { name: user.value.name } : { name: 'åŒ¿å' } };
          const list = comments.value[id] || [];
          list.unshift(item);
          comments.value[id] = list;
          localStorage.setItem('comments', JSON.stringify(comments.value));
          commentDraft.value[id] = '';
        }

        // ======= ä¸»é¡µè®¨è®ºåŒºï¼ˆç®€å•å¸–ï¼‰ =======
        const forumPosts = ref(JSON.parse(localStorage.getItem('forum_posts') || '[]')); // [{id,title,content,ts,user,likes}]
        const forumDraft = ref({ title: '', content: '' });
        const forumPostsSorted = computed(() => [...forumPosts.value].sort((a, b) => b.ts - a.ts));
        function postToForum() {
          const content = (forumDraft.value.content || '').trim();
          const title = (forumDraft.value.title || '').trim();
          if (!content) return;
          forumPosts.value.unshift({
            id: uid(),
            title,
            content,
            ts: Date.now(),
            user: user.value ? { name: user.value.name } : { name: 'åŒ¿å' },
            likes: 0
          });
          localStorage.setItem('forum_posts', JSON.stringify(forumPosts.value));
          forumDraft.value = { title: '', content: '' };
        }
        function likePost(id) {
          const p = forumPosts.value.find(x => x.id === id);
          if (!p) return;
          p.likes = (p.likes || 0) + 1;
          localStorage.setItem('forum_posts', JSON.stringify(forumPosts.value));
        }
        function seedDemoPosts() {
          if (forumPosts.value.length > 0) return;
          const now = Date.now();
          forumPosts.value = [
            { id: uid(), title: 'æ–°æ‰‹å…¥å‘æ¨è', content: 'æƒ³å…ˆç©æ²»æ„ˆç³»ï¼Œå¤§å®¶æœ‰ä»€ä¹ˆæ¨èï¼Ÿ', ts: now - 3600_000, user: { name: 'Alice' }, likes: 3 },
            { id: uid(), title: 'FLOWERS ç³»åˆ—è®¨è®º', content: 'æ˜¥/å¤/ç§‹/å†¬å„è‡ªæœ€å–œæ¬¢çš„ç« èŠ‚æ˜¯ï¼Ÿ', ts: now - 7200_000, user: { name: 'Bob' }, likes: 5 }
          ];
          localStorage.setItem('forum_posts', JSON.stringify(forumPosts.value));
        }

        // ======= æ”¶è—é¡µæ´¾ç”Ÿè§†å›¾ =======
        const favQ = ref('');
        const favGamesView = computed(() => {
          const ids = new Set([...favSet.value]);
          const q = (favQ.value || '').toLowerCase();
          return source.value.filter(g => ids.has(g.id)).filter(g => !q || (g.title.toLowerCase().includes(q) || (g.maker || '').toLowerCase().includes(q)));
        });
        const favStudiosView = computed(() => {
          const names = [...favStudios.value];
          const q = (favQ.value || '').toLowerCase();
          return names.filter(n => !q || n.toLowerCase().includes(q));
        });
        function clearFavs() {
          favSet.value.clear(); favStudios.value.clear();
          localStorage.setItem('favs', JSON.stringify([]));
          localStorage.setItem('fav_studios', JSON.stringify([]));
        }



        // ======= Authï¼šç™»å½•/æ³¨å†Œ/èµ„æ–™ =======
        const authLogin = ref({ email: '', password: '' });
        const authReg = ref({ name: '', email: '', password: '' });
        // ä¼šè¯ï¼ˆä» cookie æ¢å¤ï¼‰
        const auth = ref({ loggedIn: false, user: null, loading: true });
        const resetEmail = ref('');
        const newPassword = ref('');


        const verifyEmail = ref('');     // éªŒè¯é‚®ç®±é¡µç”¨
        const verifyCode = ref('');     // 6ä½éªŒè¯ç ï¼ˆéªŒè¯é‚®ç®±ï¼‰
        const resetCode = ref('');     // 6ä½éªŒè¯ç ï¼ˆé‡ç½®å¯†ç ï¼‰
        const otpCooldown = ref(0);      // å‘é€å€’è®¡æ—¶ï¼ˆç§’ï¼‰
        let otpTimer = null;

        // ç»Ÿä¸€è¯·æ±‚ï¼ˆå¸¦ cookieï¼‰
        const j = b => JSON.stringify(b);
        const API_BASE = 'https://galend.onrender.com';   // ä½ çš„åç«¯ç«¯å£ï¼Œapplication.properties é‡Œæ˜¯ 8080

        const api = (path, init = {}) =>
          fetch(API_BASE + path, {
            credentials: 'include',
            headers: { 'Content-Type': 'application/json', ...(init.headers || {}) },
            ...init
          });


        async function restoreSession() {
          try {
            const r = await api('/me');            // éªŒè¯ cookie è·å–ä¼šè¯
            if (!r.ok) throw 0;
            const data = await r.json();
            auth.value = { loggedIn: true, user: data.profile, loading: false };
            await migrateLocalFavsOnce();          // â† æ–°å¢
            await refreshFavoritesFromServer();    // â† æ–°å¢
          } catch {
            auth.value = { loggedIn: false, user: null, loading: false };
          }
        }

        async function doRegister() {
          const name = (authReg.value?.name || '').trim();
          const email = (authReg.value?.email || '').trim().toLowerCase();
          const pwd = authReg.value?.password || '';
          if (!name || !email || !pwd) { alert('è¯·å®Œæ•´å¡«å†™'); return; }

          if (!isEmailVerified(email)) {
            alert('è¯·å…ˆè·å–å¹¶æäº¤ 6 ä½é‚®ç®±éªŒè¯ç é€šè¿‡éªŒè¯ï¼Œå†æ³¨å†Œã€‚');
            return;
          }

          const r = await api('/auth/register', {
            method: 'POST',
            body: JSON.stringify({ displayName: name, email, password: pwd })
          });
          const data = await r.json().catch(() => ({}));
          if (!r.ok) { alert('æ³¨å†Œå¤±è´¥ï¼š' + (data.error || r.status)); return; }

          // å·²éªŒè¯åå†æ³¨å†Œï¼Œå¯ç›´æ¥ç™»å½•
          const me = await api('/me');
          if (me.ok) {
            const m = await me.json();
            auth.value = { loggedIn: true, user: m.profile, loading: false };
          }
          nav('#/home');
        }


        // ç™»å½•
        async function doLogin() {
          const email = (authLogin.value?.email || '').trim();
          const password = authLogin.value?.password || '';
          if (!email || !password) { alert('è¯·å®Œæ•´å¡«å†™'); return; }

          const r = await api('/auth/login', { method: 'POST', body: j({ email, password }) });
          const tx = await r.json().catch(() => ({}));
          if (!r.ok) { alert(tx.error || 'ç™»å½•å¤±è´¥'); return; }

          const me = await api('/me');
          if (!me.ok) { alert('è·å–ä¼šè¯å¤±è´¥'); return; }
          const data = await me.json();

          auth.value = { loggedIn: true, user: data.profile, loading: false };
          await migrateLocalFavsOnce();          // â† æ–°å¢
          await refreshFavoritesFromServer();    // â† æ–°å¢
          nav('#/home');                       // ç«‹åˆ»è·³è½¬ï¼ŒUI ç«‹å³åˆ·æ–°
        }

        async function doLogout() {
          await api('/auth/logout', { method: 'POST' });
          auth.value = { loggedIn: false, user: null, loading: false };
          nav('#/home');
        }

        async function saveProfile() {
          const body = {
            displayName: profile.value?.name || 'User',
            bio: profile.value?.bio || '',
            avatarUrl: profile.value?.avatar || ''
          };
          const r = await api('/profile', { method: 'PUT', body: j(body) });
          if (!r.ok) { alert('ä¿å­˜å¤±è´¥'); return; }

          const me = await api('/me');
          if (me.ok) {
            const data = await me.json();
            auth.value = { loggedIn: true, user: data.profile, loading: false };
          }
          alert('å·²ä¿å­˜');
        }


        // 1) æ³¨å†Œï¼šå‘é€éªŒè¯ç 
        // async function requestVerifyCode() {
        //   const email = (authReg?.value?.email || auth?.value?.user?.email || '').trim().toLowerCase();
        //   if (!email) return;
        //   const r = await api('/auth/request-code?type=VERIFY', {
        //     method: 'POST',
        //     body: j({ email })
        //   });
        //   if (!r.ok) alert((await r.text()) || 'å‘é€å¤±è´¥');
        //     startOtpCooldown(60);  
        // }

        async function requestVerifyCode() {
          const email = (authReg?.value?.email || '').trim().toLowerCase();
          if (!email) return;

          try {
            const r = await api(`/auth/request-code?type=VERIFY&email=${encodeURIComponent(email)}`, {
              method: 'POST',
              body: JSON.stringify({ email })
            });

            const txt = await r.text(); // å…ˆè¯»æ–‡æœ¬
            if (!r.ok) {
              alert(`å‘é€å¤±è´¥ (${r.status})ï¼š${txt || 'æ— è¿”å›æ–‡æœ¬'}`);
              return;
            }
            // æˆåŠŸ
            startOtpCooldown(60);
            alert(txt || 'éªŒè¯ç å·²å‘é€');
          } catch (e) {
            alert('ç½‘ç»œå¼‚å¸¸ï¼š' + e);
          }
        }
        // å¿˜è®°å¯†ç ï¼šå‘é€ 6 ä½éªŒè¯ç 
        async function requestResetCode() {
          const email = (resetEmail?.value || '').trim().toLowerCase();
          if (!email) return;
          const r = await api('/auth/request-code?type=RESET', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
          });

          if (!r.ok) alert((await r.text()) || 'å‘é€å¤±è´¥');
          startOtpCooldown(60);
        }

        // 2) æ³¨å†Œï¼šæäº¤éªŒè¯ç 
        async function submitVerifyCode() {
          const email = (authReg?.value?.email || '').trim().toLowerCase();
          const code = (verifyCode?.value || '').replace(/\D/g, '').slice(0, 6);
          if (!email || code.length !== 6) { alert('è¯·è¾“å…¥é‚®ç®±å’Œ6ä½éªŒè¯ç '); return; }

          // const r = await api(`/auth/verify-by-code?code=${encodeURIComponent(code)}`, {
          //   method: 'POST',
          //   body: JSON.stringify({ email })
          // });

          // å…ˆå°è¯•ä½ åç«¯å¸¸ç”¨çš„ verify-by-code
          let r = await api(`/auth/verify-by-code?code=${encodeURIComponent(code)}&type=VERIFY`, {
            method: 'POST',
            body: JSON.stringify({ email })
          });

          // è‹¥æ¥å£åä¸åŒï¼ˆè¿”å›404ï¼‰ï¼Œå†è¯•ä¸€ä¸ªå¸¸è§åˆ«å
          if (r.status === 404) {
            r = await api(`/auth/verify-code?type=REGISTER`, {
              method: 'POST',
              body: JSON.stringify({ email, code })
            });
          }

          if (!r.ok) { alert((await r.text()) || 'éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸ'); return; }
          markEmailVerified(email);
          alert('éªŒè¯æˆåŠŸï¼Œå¯ä»¥ç‚¹å‡»â€œæ³¨å†Œå¹¶ç™»å½•â€äº†');
        }



        // 4) å¿˜è®°å¯†ç ï¼šç”¨éªŒè¯ç é‡ç½®
        async function resetByCode() {
          const email = (resetEmail?.value || '').trim().toLowerCase();
          const code = (resetCode?.value || '').replace(/\D/g, '').slice(0, 6);
          const pwd = (newPassword?.value || '').toString();
          if (!email || code.length !== 6 || !pwd) { alert('è¯·å¡«å®Œæ•´'); return; }
          const r = await api('/auth/reset-by-code', {
            method: 'POST',
            body: j({ email, code, newPassword: pwd })
          });
          if (!r.ok) { alert((await r.text()) || 'é‡ç½®å¤±è´¥'); return; }
          alert('å¯†ç å·²é‡ç½®ï¼Œè¯·ç™»å½•');
          nav('#/login');
        }

        // éªŒè¯é‚®ç®±ï¼šè·¯ç”±è¿›å…¥æ—¶è‡ªåŠ¨è°ƒç”¨
        async function verifyEmailIfNeeded() {
          if (!route.value.startsWith('/verify')) return;
          const token = (location.hash.split('?')[1] || '').replace(/^token=/, '').split('&')[0];
          if (!token) return;
          const r = await api(`/auth/verify?token=${encodeURIComponent(token)}`);
          if (r.ok) { alert('é‚®ç®±éªŒè¯æˆåŠŸ'); await restoreSession(); nav('#/home'); }
          else { alert('éªŒè¯å¤±è´¥æˆ–é“¾æ¥è¿‡æœŸ'); nav('#/home'); }
        }

        function uploadAvatar(e) {
          const file = e.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => { profile.value.avatar = reader.result; };
          reader.readAsDataURL(file);
        }

        // æŒä¹…åŒ–ç›‘å¬
        watch([filters, q, page, yearRange, viewMode], () => {
          localStorage.setItem('filters', JSON.stringify(filters.value));
          localStorage.setItem('q', q.value);
          localStorage.setItem('page', String(page.value));
          localStorage.setItem('yearRange', JSON.stringify(yearRange.value));
          localStorage.setItem('viewMode', viewMode.value);
        }, { deep: true });

        // åˆå§‹åŒ–
        // åˆå§‹åŒ–
        onMounted(async () => {
          applyBg('./cele.jpg');
          media.addEventListener?.('change', () => { if (pref.value === 'system') applyTheme(); });

          // 1) å…ˆæŠŠ UI/ä¸»é¢˜è¿™äº›ä¸€æ¬¡æ€§æŒ‚å¥½
          mountDynamicBackground();

          refreshUserEntry();
          bindAvatarMenu();

          await restoreSession();


          // 1) æ‹‰å–æœ€æ–°çš„ games.jsonï¼ˆç¦æ­¢ç¼“å­˜ï¼‰
          const res = await fetch(`assets/games.json?v=${Date.now()}`, { cache: 'no-store' });
          const list = await res.json();

          // 2) å–‚ç»™æ•°æ®æºï¼Œç„¶åå†åšç­›é€‰
          source.value = Array.isArray(list) ? list : [];
          view.value = [...source.value];



          // è¯»å–åˆ¶ä½œç¤¾
          try {
            const sres = await fetch(`assets/studios.json?v=${Date.now()}`, { cache: 'no-store' });
            const smap = await sres.json();
            console.log('studios.json keys:', Object.keys(smap || {}));
            studios.value = smap || {};
          } catch (e) {
            console.warn('è¯»å– assets/studios.json å¤±è´¥ï¼š', e);
            studios.value = {};
          }
          applyFilters();


          await verifyEmailIfNeeded();


          // å»º Fuse ç´¢å¼•ï¼ˆä¸­æ–‡ä¹Ÿèƒ½ç”¨ï¼Œé˜ˆå€¼å¯æŒ‰éœ€è°ƒæ•´ï¼‰
          // æ³¨æ„ï¼štitle/altTitles æƒé‡å¤§ä¸€äº›ï¼Œdesc æƒé‡æœ€å°
          fuse.value = new Fuse(list, {
            includeScore: true,
            threshold: 0.34,           // 0~1 è¶Šå°è¶Šä¸¥æ ¼ï¼Œå»ºè®® 0.28~0.38 åŒºé—´
            distance: 100,
            minMatchCharLength: 1,
            keys: [
              { name: 'title', weight: 2.0 },
              { name: 'altTitles', weight: 1.6 },
              { name: 'maker', weight: 1.3 },
              { name: 'tags', weight: 1.2 },
              { name: 'platforms', weight: 0.8 },
              { name: 'desc', weight: 0.35 }
            ]
          });

          // 3) åº”ç”¨ç­›é€‰ & æ‰“å¼€éª¨æ¶
          setTimeout(() => (loading.value = false), 280);

          // 4) å¿«æ·é”®
          window.addEventListener('keydown', (e) => {
            if (e.key === '/' && !['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
              e.preventDefault();
              document.querySelector('input[placeholder^="æœç´¢"]')?.focus();
            }
            // if (e.key.toLowerCase() === 'd') toggleDark();
            if (e.key === 'Escape') {
              if (openAgeGate.value) openAgeGate.value = false;
              if (quickView.value) quickView.value = null;
            }
          });

          // 5) è‹¥å¸¦ ?to=resourcesï¼Œç­‰ DOM å‡ºæ¥åæ»šåˆ°é”šç‚¹
          setTimeout(scrollIfAnchor, 50);
        });


        function scrollIfAnchor() {
          const { q } = routeParam();
          if (q.to === 'resources') {
            // ç­‰ DOM å‡ºæ¥å†æ»šåŠ¨
            setTimeout(() => {
              document.getElementById('resources')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
          }
        }
        window.addEventListener('hashchange', scrollIfAnchor, { passive: true });
        scrollIfAnchor();




        // === æ‚¬åœæ‰“å¼€â€œå¿«é€Ÿè¯¦æƒ…â€ ===
        const hoverTimer = ref(null);
        const lastHoverId = ref(null);

        function scheduleQuickView(g, delay = 520) {
          // ç§»åŠ¨ç«¯ä¸ç”¨ hoverï¼Œç›´æ¥å¿½ç•¥
          if (matchMedia('(hover: none)').matches) return;
          cancelQuickView();                 // å…ˆæ¸…æ‰æ—§çš„å®šæ—¶å™¨
          lastHoverId.value = typeof g === 'string' ? g : g?.id;
          hoverTimer.value = setTimeout(() => {
            const item = typeof g === 'string'
              ? source.value.find(x => x.id === g)
              : g;
            if (item) quickView.value = JSON.parse(JSON.stringify(item));
          }, delay);
        }
        function cancelQuickView() {
          if (hoverTimer.value) { clearTimeout(hoverTimer.value); hoverTimer.value = null; }
          lastHoverId.value = null;
        }

        // å¯é€‰ï¼šç»™ç‚¹å‡»/é”®ç›˜ç›´æ¥æ‰“å¼€
        function openQuickViewImmediate(g) {
          const item = typeof g === 'string' ? source.value.find(x => x.id === g) : g;
          if (item) quickView.value = JSON.parse(JSON.stringify(item));
        }

        function isMediaFile(u=''){ return /\.(mp4|webm|ogg)(\?.*)?$/i.test(u); }

function embedUrl(u=''){
  if(!u) return '';
  // æå– BVã€åˆ†Pä¸èµ·å§‹ç§’
  const bv = (u.match(/BV[\w]+/)||[])[0];
  if(!bv) return '';
  let p=1, t=0;
  try{
    const url = new URL(u, location.href);
    p = Number(url.searchParams.get('p')) || 1;
    t = Number(url.searchParams.get('t')) || 0;
  }catch{}
  return `https://player.bilibili.com/player.html?bvid=${bv}&p=${p}&t=${t}&autoplay=1&muted=1`;
}


        // æš´éœ²åˆ°æ¨¡æ¿
        return {
          // è·¯ç”±
          route, nav,
          auth, doLogout,
          // éªŒè¯ç /æ‰¾å›å¯†ç åŒºç”¨åˆ°çš„ï¼š
          otpCooldown, verifyCode, resetEmail, resetCode, newPassword,
          requestVerifyCode, requestResetCode, submitVerifyCode, resetByCode,
          isEmailVerified,
          avatarOpen,
          currentGame,
          // ç”¨æˆ· & ä¸»é¢˜
          user, isLoggedIn, profile, saveProfile, uploadAvatar,
          authLogin, authReg, doLogin, doRegister,
          pref,
          toggleDark,
          // é¡¶éƒ¨çŠ¶æ€
          q, openAgeGate, ageVerified, quickView, showNav, isDark, loading, viewMode,
          // è¿‡æ»¤
          filters, platforms, tagPool, applyFilters, resetFilters, toggleTag, debouncedApply,
          // å¹´ä»½
          minYear, maxYear, yearRange, fixYearOrder, resetYears,
          // æ•°æ®æ´¾ç”Ÿ
          view, pageView, page, pages, total, pageNumbers,
          timelineMap, timelineYears,
          // åˆ¶ä½œç¤¾å›¾é‰´
          studios, studioQ, studioSort, studioView, bannerCandidates,  isMediaFile,
  embedUrl,

          // äº¤äº’æ–¹æ³•
          fmtDate, fmtTime, confirmAdult, openQuickView: openQuickViewFn, toPage,
          openGameLink, goGame,
          // æ”¶è—/è¯„åˆ†
          toggleFav, isFav, rate, getRate,
          toggleFavStudio, isFavStudio,
          // æ”¶è—é¡µ
          favQ, favGamesView, favStudiosView, clearFavs,
          // å ä½å›¾
          coverAnime, galleryAnime,
          // è®¨è®ºåŒº
          forumPosts, forumDraft, forumPostsSorted, postToForum, likePost, seedDemoPosts,
          // è¯„è®º
          commentsBy, commentDraft, submitComment,
          //æ‚¬åœ
          scheduleQuickView, cancelQuickView, openQuickViewImmediate
        };
      }
    }).mount('#app');
  </script>
</body>


</html>

